<!DOCTYPE html>
<html lang="zh-TW">

<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>勤務案件管理-編輯(廠商)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .fixed-bottom-bar {
            position: fixed;
            left: 0;
            bottom: 0;
            width: 100vw;
            z-index: 50;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.06);
            background: #fff;
        }

        .work-photo-preview {
            min-height: 200px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 8px;
        }

        .work-photo-preview img,
        .work-photo-preview video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }

        @media (max-width: 640px) {
            .form-section-grid {
                display: flex;
                flex-direction: column;
                gap: 1rem;
            }

            .bottom-btns {
                flex-direction: row !important;
                gap: 0.75rem !important;
                align-items: center !important;
            }

            .upload-section {
                flex-direction: column !important;
                gap: 1rem !important;
            }

            .upload-section>div {
                margin-bottom: 0.5rem;
            }

            .main-padding {
                padding: 1rem !important;
            }

            .page-title {
                font-size: 1.25rem !important;
            }

            /* 電子簽章區塊手機版維持並列 */
            .signature-row {
                display: grid !important;
                grid-template-columns: 1fr 1fr !important;
                gap: 1rem !important;
            }

            .address-row {
                flex-direction: row !important;
                gap: 1rem !important;
            }

            .address-input-row {
                margin-top: 0.5rem !important;
            }
        }

        .work-photo-preview {
            width: 100px;
            height: 100px;
            border-radius: 0.5rem;
            overflow: hidden;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 物種狀況橫向排列 */
        @media (min-width: 768px) {
            .species-status-row {
                display: flex;
                flex-direction: row;
                gap: 1rem;
                align-items: flex-start;
            }

            .species-status-row>* {
                min-width: 180px;
                flex: 1 1 0;
            }
        }

        /* 新增預覽區塊固定尺寸CSS */
        .work-photo-preview.relative {
            width: 200px;
            height: 200px;
            min-width: 200px;
            min-height: 200px;
            max-width: 200px;
            max-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .work-photo-preview.relative img,
        .work-photo-preview.relative video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }

        /* 通報地址響應式樣式 */
        @media (max-width: 640px) {
            .address-row {
                flex-wrap: wrap !important;
            }

            .address-row>select {
                flex-basis: calc(50% - 0.375rem) !important;
            }

            .address-input {
                flex-basis: 100% !important;
                margin-top: 0.5rem !important;
            }
        }

        @media (min-width: 641px) {
            .address-row {
                flex-wrap: nowrap !important;
            }

            .address-input {
                flex-basis: auto !important;
                margin-top: 0 !important;
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css" crossorigin="anonymous">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#6C936D',
                        'secondary': '#3F5146',
                        'accent': '#417991',
                        'danger': '#DC3545',
                        'warning': '#EAD065',
                        'gray-light': '#F8F9FA',
                        'gray-medium': '#6C757D',
                        'gray-dark': '#495057',
                        'border': '#ADB5BD',
                        'green-light': '#C5E0C7',
                        'bg-light': '#F3F3F3'
                    },
                    fontFamily: {
                        'noto': ['Noto Sans TC', 'sans-serif']
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-bg-light font-noto">
    <!-- 引入 header.html -->
    <div id="header"></div>
    <script>
        fetch('header.html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('header').innerHTML = html;
                // 手動初始化 header 功能
                if (window.initializeHeader) {
                    window.initializeHeader();
                }
            });
    </script>
    <script src="header-utils.js"></script>

    <main class="p-2 md:p-4 max-w-[1440px] mx-auto">
        <!-- 指派倒數計時區塊 -->
        <div id="assignCountdownBar" style="display:none;"
            class="mb-4 flex items-center gap-2 bg-warning bg-opacity-80 text-gray-dark rounded px-4 py-2 font-bold text-lg">
            <i class="fas fa-hourglass-half text-danger"></i>
            <span>指派後倒數：</span>
            <span id="assignCountdownText">10:00</span>
        </div>
        <!-- 頁面標題 -->
        <div class="bg-white shadow-lg rounded-lg border-l-4 border-primary p-2 mb-4">
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center px-2 md:px-4 py-2 gap-2">
                <h2 class="text-xl md:text-2xl font-bold text-secondary">勤務案件管理-編輯(廠商)</h2>
                <div class="flex items-center gap-1 text-gray-medium text-sm">
                    <span>首頁</span>
                    <span>/</span>
                    <span>勤務案件管理</span>
                    <span>/</span>
                    <span>勤務案件管理</span>
                    <span>/</span>
                    <span class="text-primary font-bold">編輯(廠商)</span>
                </div>
            </div>
        </div>

        <!-- 表單區塊 -->
        <form class="bg-white rounded-lg shadow-lg border border-gray-200 p-4 md:p-6 lg:p-8 space-y-8">
            <!-- 通報基本資料 -->
            <section>
                <div
                    class="flex items-center gap-2 mb-4 bg-gray-light border-l-2 border-primary px-4 py-2 justify-between">
                    <div class="flex items-center gap-2">
                        <!-- 通報基本資料 icon -->
                        <i class="fas fa-clipboard text-primary w-4 h-4 mr-1"></i>
                        <h3 class="text-lg md:text-xl font-bold text-primary">通報資料</h3>
                    </div>
                    <div class="flex items-center gap-2">
                        <button type="button" id="toggleBasicInfoBtn"
                            class="bg-primary text-white px-3 py-1 rounded text-sm font-medium hover:bg-green-700 transition">
                            <span id="toggleBasicInfoText">收合</span>
                            <i id="toggleBasicInfoIcon" class="fas fa-chevron-up ml-1"></i>
                        </button>
                        <button type="button" id="editBasicBtn"
                            class="bg-primary text-white px-3 py-1 rounded text-sm font-medium hover:bg-green-700 transition">資料修正</button>
                    </div>
                </div>
                <div class="border border-border rounded p-4" id="basicInfoBlock">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label class="block text-gray-dark font-medium mb-1">立案編號</label>
                            <input type="text"
                                class="w-full min-w-0 border border-border rounded px-3 py-2 bg-white text-gray-dark focus:outline-primary "
                                value="T1130428001">
                        </div>
                        <div>
                            <label class="flex items-center text-gray-dark font-medium mb-1">
                                <span class="text-danger mr-1">*</span>通報來源
                            </label>
                            <select
                                class="w-full min-w-0 border border-border rounded px-3 py-2 bg-white focus:outline-primary ">
                                <option selected>119</option>
                                <option>19999</option>
                                <option>1959</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-dark font-medium mb-1">通報時間</label>
                            <input type="text"
                                class="w-full min-w-0 border border-border rounded px-3 py-2 bg-white focus:outline-primary "
                                value="2024/04/28 20:20:21">
                        </div>
                        <div>
                            <label class="flex items-center text-gray-dark font-medium mb-1">
                                <span class="text-danger mr-1">*</span>通報人
                            </label>
                            <input type="text"
                                class="w-full min-w-0 border border-border rounded px-3 py-2 bg-white focus:outline-primary "
                                placeholder="請輸入" value="王小明">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label class="flex items-center text-gray-dark font-medium mb-1">
                                <span class="text-danger mr-1">*</span>性別
                            </label>
                            <div class="flex flex-wrap items-center gap-4 mt-1 min-w-0">
                                <label class="inline-flex items-center">
                                    <input type="radio" name="gender" class="text-primary mr-2" checked>
                                    <span>先生</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="gender" class="text-primary mr-2">
                                    <span>小姐</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="gender" class="text-primary mr-2">
                                    <span>其他</span>
                                </label>
                                <!-- <input type="text" class="border border-border rounded px-2 py-1 text-sm flex-1 min-w-0 ml-2"
                                    placeholder="請輸入" readonly> -->
                            </div>
                        </div>
                        <div>
                            <label class="flex items-center text-gray-dark font-medium mb-1">
                                <span class="text-danger mr-1">*</span>通報人電話
                            </label>
                            <input type="text"
                                class="w-full min-w-0 border border-border rounded px-3 py-2 bg-white focus:outline-primary "
                                placeholder="請輸入" value="0912345678">
                        </div>
                        <div>
                            <label class="flex items-center text-gray-dark font-medium mb-1">
                                <span class="text-danger mr-1">*</span>電話值班人員
                            </label>
                            <input type="text"
                                class="w-full min-w-0 border border-border rounded px-3 py-2 bg-white focus:outline-primary "
                                placeholder="請輸入" value="林值班">
                        </div>
                        <div>
                            <label class="flex items-center text-gray-dark font-medium mb-1">
                                <span class="text-danger mr-1">*</span>案件類型
                            </label>
                            <select id="basicCaseTypeSelect"
                                class="w-full min-w-0 border border-border rounded px-3 py-2 bg-white focus:outline-primary">
                                <option>補蜂</option>
                                <option selected>捉蛇</option>
                                <option>動物救援</option>
                                <option>綠鬣蜥</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="flex items-center text-gray-dark font-medium mb-1">
                            <span class="text-danger mr-1">*</span>通報地址
                        </label>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-2">
                            <!-- 鄉鎮市 -->
                            <div>
                                <select
                                    class="w-full border border-border rounded px-2 py-2 bg-white focus:outline-primary text-sm">
                                    <option>屏東市</option>
                                    <option selected>潮州鎮</option>
                                </select>
                            </div>
                            <!-- 路街段 -->
                            <div>
                                <select
                                    class="w-full border border-border rounded px-2 py-2 bg-white focus:outline-primary text-sm">
                                    <option>八德路</option>
                                    <option>八龍路</option>
                                    <option>力行巷</option>
                                    <option>三水街</option>
                                    <option>三民路</option>
                                    <option>三光路</option>
                                    <option>三合路</option>
                                    <option>三林路</option>
                                    <option>三城路</option>
                                    <option>三春路</option>
                                    <option>三星一巷</option>
                                    <option>三星二巷</option>
                                    <option>三星路</option>
                                    <option>三蒼路</option>
                                </select>
                            </div>
                            <!-- 詳細地址 -->
                            <div>
                                <input type="text"
                                    class="w-full border border-border rounded px-2 py-2 bg-white focus:outline-primary text-sm"
                                    placeholder="請輸入詳細地址">
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <!-- 內勤作業紀錄 -->
            <section>
                <div
                    class="flex items-center gap-2 mb-4 bg-gray-light border-l-2 border-primary px-4 py-2 justify-between">
                    <div class="flex items-center gap-2">
                        <!-- 內勤作業紀錄 icon -->
                        <i class="fas fa-clipboard text-primary w-4 h-4 mr-1"></i>
                        <h3 class="text-lg md:text-xl font-bold text-primary">內勤作業紀錄</h3>
                    </div>
                    <button type="button" id="toggleDutyRecordBtn"
                        class="bg-primary text-white px-3 py-1 rounded text-sm font-medium hover:bg-green-700 transition">
                        <span id="toggleDutyRecordText">收合</span>
                        <i id="toggleDutyRecordIcon" class="fas fa-chevron-up ml-1"></i>
                    </button>
                </div>
                <div class="border border-border rounded p-4" id="dutyRecordBlock">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label class="flex items-center text-gray-dark font-medium mb-1">
                                <span class="text-danger mr-1">*</span>作業廠商
                            </label>
                            <select
                                class="w-full border border-border rounded px-3 py-2 bg-white focus:outline-primary">
                                <option>請選擇</option>
                                <option selected>廠商A</option>
                                <option>廠商B</option>
                            </select>
                        </div>
                        <div>
                            <label class="flex items-center text-gray-dark font-medium mb-1">
                                <span class="text-danger mr-1">*</span>作業人員
                            </label>
                            <select
                                class="w-full border border-border rounded px-3 py-2 bg-white focus:outline-primary">
                                <option>請選擇</option>
                                <option selected>許○○</option>
                                <option>王○○</option>
                                <option>李○○</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-dark font-medium mb-1">物種名稱</label>
                            <select id="dutySpeciesSelect"
                                class="w-full border border-border rounded px-3 py-2 bg-white focus:outline-primary">
                                <option>請選擇</option>
                                <option selected>眼鏡蛇</option>
                                <option>虎頭蜂</option>
                                <option>長腳蜂</option>
                                <option>球蟒</option>
                                <option>白鼻心</option>
                                <option>綠鬣蜥</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-dark font-medium mb-1">廠商聯繫通報人時間</label>
                            <input type="text"
                                class="w-full border border-border rounded px-3 py-2 bg-gray-light focus:outline-primary"
                                value="2025/07/28 04:37:50" readonly>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label class="flex items-center text-gray-dark font-medium mb-1">
                                <span class="text-danger mr-1">*</span>通報人願意於現場等待
                            </label>
                            <div class="flex items-center gap-4 mt-1">
                                <label class="inline-flex items-center">
                                    <input type="radio" name="waitOnSite" class="text-primary mr-2" value="是">
                                    <span>是</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="waitOnSite" class="text-primary mr-2" value="否" checked>
                                    <span>否</span>
                                </label>
                            </div>
                        </div>
                        <div>
                            <label class="flex items-center text-gray-dark font-medium mb-1">
                                <span class="text-danger mr-1">*</span>通報物仍在現場，尚未脫逃
                            </label>
                            <div class="flex items-center gap-4 mt-1">
                                <label class="inline-flex items-center">
                                    <input type="radio" name="stillOnSite" class="text-primary mr-2" value="是">
                                    <span>是</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="stillOnSite" class="text-primary mr-2" value="否" checked>
                                    <span>否</span>
                                </label>
                            </div>
                        </div>
                        <div>
                            <label class="flex items-center text-gray-dark font-medium mb-1">
                                <span class="text-danger mr-1">*</span>是否有飼主
                            </label>
                            <div class="flex items-center gap-4 mt-1">
                                <label class="inline-flex items-center">
                                    <input type="radio" name="hasOwner" class="text-primary mr-2" value="是">
                                    <span>是</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="hasOwner" class="text-primary mr-2" value="否" checked>
                                    <span>否</span>
                                </label>
                            </div>
                        </div>
                        <div>
                            <!-- 空白欄位 -->
                        </div>
                    </div>
                </div>
                </div>
            </section>
            <!-- 外勤作業紀錄 -->
            <section>
                <div class="flex items-center justify-between mb-4 bg-gray-light border-l-2 border-primary px-4 py-2">
                    <div class="flex items-center gap-2">
                        <!-- 外勤作業紀錄 icon -->
                        <i class="fas fa-image text-primary w-4 h-4 mr-1"></i>
                        <h3 class="text-lg md:text-xl font-bold text-primary">外勤作業紀錄</h3>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-dark">回報日期： yyy/mm/dd</span>
                        <button type="button" id="acceptDispatchBtn"
                            class="min-w-[96px] bg-primary text-white px-4 py-2 rounded hover:bg-green-700 transition flex items-center gap-1">
                            <i class="fas fa-inbox mr-1"></i>接收派案
                        </button>
                    </div>
                </div>
                <div class="border border-border rounded p-4" id="fieldWorkBlock" style="display:none;">
                    <!-- 第一行：值勤人員抵達時間 -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <div class="min-w-0 md:col-span-2 flex flex-col">
                            <label class="flex items-center text-gray-dark font-medium mb-1">
                                <span class="text-danger mr-1">*</span>值勤人員抵達時間
                                <script>
                                    // radio預設都設為「是」
                                    document.addEventListener('DOMContentLoaded', function () {
                                        var waitYes = document.querySelector('input[name="waitOnSite"][value="是"]');
                                        var waitNo = document.querySelector('input[name="waitOnSite"][value="否"]');
                                        var stillYes = document.querySelector('input[name="stillOnSite"][value="是"]');
                                        var stillNo = document.querySelector('input[name="stillOnSite"][value="否"]');
                                        if (waitYes) waitYes.checked = true;
                                        if (waitNo) waitNo.checked = false;
                                        if (stillYes) stillYes.checked = true;
                                        if (stillNo) stillNo.checked = false;
                                    });
                                </script>
                            </label>
                            <div class="flex flex-col md:flex-row gap-2 min-w-0 w-full">
                                <input type="text" id="arriveTimeField"
                                    class="flex-1 min-w-0 border border-border rounded px-3 py-2 bg-white focus:outline-primary md:w-40"
                                    placeholder="-">
                                <button type="button" id="getLocationBtn"
                                    class="bg-accent text-white px-3 py-2 rounded text-sm flex items-center gap-1 md:w-28">
                                    <img src="img/location-arrow.png" alt="location"
                                        class="w-3 h-3 filter brightness-0 invert">
                                    定位
                                </button>
                                <input type="text" id="locationField"
                                    class="border border-border rounded px-3 py-2 bg-gray-light text-sm flex-1 min-w-0 md:w-48"
                                    placeholder="座標" readonly>
                            </div>
                        </div>
                        <div></div>
                        <div></div>
                    </div>
                    <!-- 第二行：四個radio欄位 -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label class="flex items-center text-gray-dark font-medium mb-1">
                                <span class="text-danger mr-1">*</span>通報人仍在現場
                            </label>
                            <div class="flex items-center gap-4 mt-1">
                                <label class="inline-flex items-center">
                                    <input type="radio" name="waitOnSite" class="text-primary mr-2" value="是">
                                    <span>是</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="waitOnSite" class="text-primary mr-2" value="否">
                                    <span>否</span>
                                </label>
                            </div>
                        </div>
                        <div>
                            <label class="flex items-center text-gray-dark font-medium mb-1">
                                <span class="text-danger mr-1">*</span>通報物仍在現場，尚未脫逃
                            </label>
                            <div class="flex items-center gap-4 mt-1">
                                <label class="inline-flex items-center">
                                    <input type="radio" name="stillOnSite" class="text-primary mr-2" value="是">
                                    <span>是</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="stillOnSite" class="text-primary mr-2" value="否">
                                    <span>否</span>
                                </label>
                            </div>
                        </div>
                        <div>
                            <label class="flex items-center text-gray-dark font-medium mb-1">
                                <span class="text-danger mr-1">*</span>是否為通報案件類型
                            </label>
                            <div class="flex items-center gap-4 mt-1">
                                <label class="inline-flex items-center">
                                    <input type="radio" name="correctCaseType" class="text-primary mr-2" value="是">
                                    <span>是</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="correctCaseType" class="text-primary mr-2" value="否">
                                    <span>否</span>
                                </label>
                            </div>
                        </div>
                        <div>
                            <label class="flex items-center text-gray-dark font-medium mb-1">
                                <span class="text-danger mr-1">*</span>是否有飼主
                            </label>
                            <div class="flex items-center gap-4 mt-1">
                                <label class="inline-flex items-center">
                                    <input type="radio" name="hasOwnerField" class="text-primary mr-2" value="是">
                                    <span>是</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="hasOwnerField" class="text-primary mr-2" value="否">
                                    <span>否</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <!-- 第三行：物種相關欄位 -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label class="flex items-center text-gray-dark font-medium mb-1">
                                <span class="text-danger mr-1">*</span>物種名稱
                            </label>
                            <select id="fieldSpeciesSelect"
                                class="w-full border border-border rounded px-3 py-2 bg-white focus:outline-primary">
                                <option value="">眼鏡蛇</option>
                                <option value="虎頭蜂">虎頭蜂</option>
                                <option value="長腳蜂">長腳蜂</option>
                                <option value="球蟒">球蟒</option>
                                <option value="白鼻心">白鼻心</option>
                                <option value="綠鬣蜥">綠鬣蜥</option>
                            </select>
                        </div>
                        <div>
                            <label class="flex items-center text-gray-dark font-medium mb-1">
                                <span class="text-danger mr-1">*</span>數量
                            </label>
                            <input type="text"
                                class="w-full border border-border rounded px-3 py-2 bg-white focus:outline-primary"
                                placeholder="1" value="1">
                        </div>
                        <div>
                            <label class="flex items-center text-gray-dark font-medium mb-1">
                                <span class="text-danger mr-1">*</span>物種狀況
                            </label>
                            <select id="fieldSpeciesStatusSelect"
                                class="w-full border border-border rounded px-3 py-2 bg-white focus:outline-primary">
                                <option value="">請選擇</option>
                                <option value="健康">健康</option>
                                <option value="受傷">受傷</option>
                                <!-- <option value="到場前已自行脫逃">到場前已自行脫逃</option> -->
                            </select>
                        </div>
                        <div>
                            <label class="flex items-center text-gray-dark font-medium mb-1">
                                <span class="text-danger mr-1">*</span>處理情形
                            </label>
                            <select id="fieldProcessSelect"
                                class="w-full border border-border rounded px-3 py-2 bg-white focus:outline-primary">
                                <option>安全處野放</option>
                                <option>到場無法救援</option>
                                <option selected>後送</option>
                                <option>攜回</option>
                            </select>
                        </div>
                    </div>
                    <!-- 第四行：通報人是否願意支付費用 -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label class="flex items-center text-gray-dark font-medium mb-1">
                                <span class="text-danger mr-1">*</span>通報人是否願意支付費用
                            </label>
                            <div class="flex items-center gap-4 mt-1">
                                <label class="inline-flex items-center">
                                    <input type="radio" name="paymentWilling" class="text-primary mr-2" value="是">
                                    <span>是</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="paymentWilling" class="text-primary mr-2" value="否">
                                    <span>否</span>
                                </label>
                            </div>
                        </div>
                        <div></div>
                        <div></div>
                        <div></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <div></div>
                        <div></div>
                        <div></div>
                        <div></div>
                    </div>

                    <!-- 新增犬貓案件細部選項區塊 -->
                    <div id="strayEscapeBlock" style="display:none;">
                        <label class="flex items-center text-gray-dark font-medium mb-1">
                            <span class="text-danger mr-1">*</span>到場前已逃跑？
                        </label>
                        <select id="strayEscapeSelect"
                            class="w-full border border-border rounded px-3 py-2 bg-white focus:outline-primary">
                            <option value="">請選擇</option>
                            <option value="是">是</option>
                            <option value="否">否</option>
                        </select>
                    </div>
                    <div id="strayInjuredToolBlock" style="display:none;">
                        <!-- 已移除「是否可用工具處理？」欄位 -->
                    </div>

                    <!-- 外勤作業照片上傳區 -->
                    <div class="mt-6 px-4">
                        <h4 class="text-lg font-bold mb-4 text-gray-dark">外勤作業照片</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <!-- 處理前紀錄 -->
                            <div id="workPhotoBlock1"
                                class="work-photo-block w-full p-4 rounded-lg border border-gray-200">
                                <div class="work-photo-title flex items-center text-gray-dark font-medium mb-3">
                                    <span class="text-danger mr-1">*</span><span>處理前紀錄</span>
                                    <span class="text-xs text-gray-500 ml-2">(<span id="photoCount1">0</span>/4)</span>
                                </div>
                                <div id="workPhotoPreview1"
                                    class="work-photo-preview grid grid-cols-4 gap-2 w-full min-h-[80px]">
                                    <!-- 照片位置1 -->
                                    <div class="photo-slot relative aspect-square w-full" style="display:none;">
                                        <img class="w-full h-full object-cover rounded cursor-pointer" alt="照片1">
                                        <button type="button"
                                            class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center z-10">&times;</button>
                                    </div>
                                    <!-- 照片位置2 -->
                                    <div class="photo-slot relative aspect-square w-full" style="display:none;">
                                        <img class="w-full h-full object-cover rounded cursor-pointer" alt="照片2">
                                        <button type="button"
                                            class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center z-10">&times;</button>
                                    </div>
                                    <!-- 照片位置3 -->
                                    <div class="photo-slot relative aspect-square w-full" style="display:none;">
                                        <img class="w-full h-full object-cover rounded cursor-pointer" alt="照片3">
                                        <button type="button"
                                            class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center z-10">&times;</button>
                                    </div>
                                    <!-- 照片位置4 -->
                                    <div class="photo-slot relative aspect-square w-full" style="display:none;">
                                        <img class="w-full h-full object-cover rounded cursor-pointer" alt="照片4">
                                        <button type="button"
                                            class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center z-10">&times;</button>
                                    </div>
                                    <!-- 上傳按鈕 -->
                                    <label for="workPhotoInput1"
                                        class="upload-slot bg-white border-2 border-dashed border-gray-300 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:bg-gray-100 hover:border-primary text-gray-400 hover:text-primary transition-colors aspect-square w-full">
                                        <i class="fas fa-plus text-xl"></i>
                                        <div class="text-xs font-medium mt-1">新增照片</div>
                                    </label>
                                </div>
                                <input type="file" id="workPhotoInput1" accept="image/*" multiple style="display:none;">
                                <div id="workPhotoTip1" class="text-xs text-gray-500 mt-2">
                                    可上傳的檔案格式：jpg、jpeg、png，最多4張，每張最大 2MB。
                                </div>
                            </div>

                            <!-- 處理中紀錄 -->
                            <div id="workPhotoBlock2"
                                class="work-photo-block w-full p-4 rounded-lg border border-gray-200">
                                <div class="work-photo-title flex items-center text-gray-dark font-medium mb-3">
                                    <span class="text-danger mr-1"
                                        style="visibility:hidden;">*</span><span>處理中紀錄(非必填)</span>
                                    <span class="text-xs text-gray-500 ml-2">(<span id="photoCount2">0</span>/4)</span>
                                </div>
                                <div id="workPhotoPreview2"
                                    class="work-photo-preview grid grid-cols-4 gap-2 w-full min-h-[80px]">
                                    <!-- 照片位置1 -->
                                    <div class="photo-slot relative aspect-square w-full" style="display:none;">
                                        <img class="w-full h-full object-cover rounded cursor-pointer" alt="照片1">
                                        <button type="button"
                                            class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center z-10">&times;</button>
                                    </div>
                                    <!-- 照片位置2 -->
                                    <div class="photo-slot relative aspect-square w-full" style="display:none;">
                                        <img class="w-full h-full object-cover rounded cursor-pointer" alt="照片2">
                                        <button type="button"
                                            class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center z-10">&times;</button>
                                    </div>
                                    <!-- 照片位置3 -->
                                    <div class="photo-slot relative aspect-square w-full" style="display:none;">
                                        <img class="w-full h-full object-cover rounded cursor-pointer" alt="照片3">
                                        <button type="button"
                                            class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center z-10">&times;</button>
                                    </div>
                                    <!-- 照片位置4 -->
                                    <div class="photo-slot relative aspect-square w-full" style="display:none;">
                                        <img class="w-full h-full object-cover rounded cursor-pointer" alt="照片4">
                                        <button type="button"
                                            class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center z-10">&times;</button>
                                    </div>
                                    <!-- 上傳按鈕 -->
                                    <label for="workPhotoInput2"
                                        class="upload-slot bg-white border-2 border-dashed border-gray-300 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:bg-gray-100 hover:border-primary text-gray-400 hover:text-primary transition-colors aspect-square w-full">
                                        <i class="fas fa-plus text-xl"></i>
                                        <div class="text-xs font-medium mt-1">新增照片</div>
                                    </label>
                                </div>
                                <input type="file" id="workPhotoInput2" accept="image/*" multiple style="display:none;">
                                <div id="workPhotoTip2" class="text-xs text-gray-500 mt-2">
                                    可上傳的檔案格式：jpg、jpeg、png，最多4張，每張最大 2MB。
                                </div>
                            </div>

                            <!-- 處理完成紀錄 -->
                            <div id="workPhotoBlock3"
                                class="work-photo-block w-full p-4 rounded-lg border border-gray-200">
                                <div class="work-photo-title flex items-center text-gray-dark font-medium mb-3">
                                    <span class="text-danger mr-1">*</span><span>處理完成紀錄</span>
                                    <span class="text-xs text-gray-500 ml-2">(<span id="photoCount3">0</span>/4)</span>
                                </div>
                                <div id="workPhotoPreview3"
                                    class="work-photo-preview grid grid-cols-4 gap-2 w-full min-h-[80px]">
                                    <!-- 照片位置1 -->
                                    <div class="photo-slot relative aspect-square w-full" style="display:none;">
                                        <img class="w-full h-full object-cover rounded cursor-pointer" alt="照片1">
                                        <button type="button"
                                            class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center z-10">&times;</button>
                                    </div>
                                    <!-- 照片位置2 -->
                                    <div class="photo-slot relative aspect-square w-full" style="display:none;">
                                        <img class="w-full h-full object-cover rounded cursor-pointer" alt="照片2">
                                        <button type="button"
                                            class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center z-10">&times;</button>
                                    </div>
                                    <!-- 照片位置3 -->
                                    <div class="photo-slot relative aspect-square w-full" style="display:none;">
                                        <img class="w-full h-full object-cover rounded cursor-pointer" alt="照片3">
                                        <button type="button"
                                            class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center z-10">&times;</button>
                                    </div>
                                    <!-- 照片位置4 -->
                                    <div class="photo-slot relative aspect-square w-full" style="display:none;">
                                        <img class="w-full h-full object-cover rounded cursor-pointer" alt="照片4">
                                        <button type="button"
                                            class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center z-10">&times;</button>
                                    </div>
                                    <!-- 上傳按鈕 -->
                                    <label for="workPhotoInput3"
                                        class="upload-slot bg-white border-2 border-dashed border-gray-300 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:bg-gray-100 hover:border-primary text-gray-400 hover:text-primary transition-colors aspect-square w-full">
                                        <i class="fas fa-plus text-xl"></i>
                                        <div class="text-xs font-medium mt-1">新增照片</div>
                                    </label>
                                </div>
                                <input type="file" id="workPhotoInput3" accept="image/*" multiple style="display:none;">
                                <div id="workPhotoTip3" class="text-xs text-gray-500 mt-2">
                                    可上傳的檔案格式：jpg、jpeg、png，最多4張，每張最大 2MB。
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <!-- 後送作業 -->
            <section id="transferSection" style="display:none;">
                <div class="flex items-center gap-2 mb-4 bg-gray-light border-l-2 border-primary px-4 py-2">
                    <!-- 後送作業 icon -->
                    <i class="fas fa-ambulance text-primary w-4 h-4 mr-1"></i>
                    <h3 class="text-lg md:text-xl font-bold text-primary">後送作業紀錄</h3>
                </div>
                <div class="border border-border rounded p-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="flex items-center text-gray-dark font-medium mb-1">
                                <span class="text-danger mr-1">*</span>後送單位
                            </label>
                            <select
                                class="w-full border border-border rounded px-3 py-2 bg-white focus:outline-primary">
                                <option value="">請選擇</option>
                                <option value="屏東科技大學獸醫教學醫院">屏東科技大學獸醫教學醫院</option>
                                <option value="長治鄉動物醫院">長治鄉動物醫院</option>
                                <option value="潮州動物醫院">潮州動物醫院</option>
                                <option value="東港動物醫院">東港動物醫院</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                        <div>
                            <label class="flex items-center text-gray-dark font-medium mb-1">
                                <span class="text-danger mr-1">*</span>後送日期
                            </label>
                            <input type="datetime-local"
                                class="w-full border border-border rounded px-3 py-2 bg-white focus:outline-primary">
                        </div>
                        <div></div>
                    </div>

                    <!-- 後送照片上傳區 -->
                    <div class="mt-4">
                        <div class="w-full p-4 rounded-lg border border-gray-200">
                            <div class="flex items-center text-gray-dark font-medium mb-3">
                                <span class="text-danger mr-1">*</span><span>後送紀錄</span>
                                <span class="text-xs text-gray-500 ml-2">(<span
                                        id="transferPhotoCount">0</span>/1)</span>
                            </div>
                            <div id="transferPhotoPreview" class="w-full min-h-[120px] flex items-center">
                                <!-- 照片預覽區域 -->
                                <div id="transferPhotoSlot" class="relative w-32 h-32" style="display:none;">
                                    <img class="w-full h-full object-cover rounded cursor-pointer" alt="後送照片">
                                    <button type="button"
                                        class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center z-10">&times;</button>
                                </div>
                                <!-- 上傳按鈕 -->
                                <label for="transferPhotoInput" id="transferUploadSlot"
                                    class="bg-white border-2 border-dashed border-gray-300 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:bg-gray-100 hover:border-primary text-gray-400 hover:text-primary transition-colors w-32 h-32">
                                    <i class="fas fa-plus text-xl"></i>
                                    <div class="text-xs font-medium mt-1">新增照片</div>
                                </label>
                            </div>
                            <input type="file" id="transferPhotoInput" accept="image/*" style="display:none;">
                            <div class="text-xs text-gray-500 mt-2">
                                可上傳的檔案格式：jpg、jpeg、png，最多1張，每張最大 2MB。
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <!-- 電子簽章 -->
            <section>
                <div class="flex items-center gap-2 mb-4 bg-gray-light border-l-2 border-primary px-4 py-2">
                    <!-- 電子簽章 icon -->
                    <i class="fas fa-clipboard text-primary w-4 h-4 mr-1"></i>
                    <h3 class="text-lg md:text-xl font-bold text-primary">電子簽章</h3>
                </div>
                <div class="border border-border rounded p-4" id="signatureBlock" style="display:none;">
                    <div class="signature-row grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-dark font-medium mb-1">通報人</label>
                            <div class="w-full border border-border rounded bg-gray-light flex flex-col items-center justify-center"
                                style="height: 120px;">
                                <button type="button" id="openSignatureModalBtn"
                                    class="px-3 py-2 bg-primary text-white rounded text-base font-bold mt-4">簽名</button>
                                <div id="signaturePreview" class="mt-2 w-full flex justify-center"></div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-gray-dark font-medium mb-1">簽章日期</label>
                            <div class="w-full border border-border rounded bg-gray-light flex items-center justify-center"
                                style="height: 120px;">
                                <span class="ml-4 text-gray-dark font-bold text-base">2025/07/28</span>
                            </div>
                        </div>
                    </div>
                    <!-- Modal -->
                    <div id="signatureModal"
                        class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
                        <div class="bg-white rounded-lg shadow-lg p-6 flex flex-col items-center min-w-[340px]">
                            <h3 class="text-lg font-bold mb-2">通報人簽名</h3>
                            <canvas id="signatureCanvas" width="320" height="80"
                                style="background:#fff;border-radius:8px;border:1px solid #ADB5BD;max-width:100%;display:block;"></canvas>
                            <div class="flex gap-2 mt-2">
                                <button type="button" id="clearSignatureBtn"
                                    class="px-2 py-1 bg-gray-medium text-white rounded text-sm">清除</button>
                                <button type="button" id="saveSignatureBtn"
                                    class="px-2 py-1 bg-primary text-white rounded text-sm">儲存</button>
                                <button type="button" id="closeSignatureModalBtn"
                                    class="px-2 py-1 bg-gray-light text-gray-dark rounded text-sm">取消</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </form>
    </main>

    <!-- 底部按鈕 -->
    <div class="fixed-bottom-bar bg-white shadow-lg border-t border-gray-200 py-2">
        <div class="bottom-btns flex flex-wrap justify-center items-center gap-2 max-w-[1440px] mx-auto px-4">
            <button type="button"
                class="min-w-[96px] bg-white text-gray-medium border border-gray-medium px-4 py-2 rounded hover:bg-gray-100 transition">取消</button>
            <button type="button"
                class="min-w-[96px] bg-gray-medium text-white px-4 py-2 rounded hover:bg-gray-dark transition flex items-center gap-1">
                <!-- 底部按鈕 icon -->
                <i class="fas fa-save w-3.5 h-3.5 mr-1"></i>
                暫存
            </button>
            <button type="button" id="assignCaseBtn"
                class="min-w-[96px] bg-primary text-white px-4 py-2 rounded hover:bg-green-700 transition flex items-center gap-1">
                <!-- 底部按鈕 icon -->
                <i class="fas fa-paper-plane w-3.5 h-3.5 mr-1"></i>
                指派案件
            </button>
            <button type="submit"
                class="min-w-[96px] bg-primary text-white px-4 py-2 rounded hover:bg-green-700 transition flex items-center gap-1"
                style="display:none;">
                <!-- 底部按鈕 icon -->
                <i class="fas fa-check-circle w-3.5 h-3.5 mr-1"></i>
                提交縣府
            </button>
        </div>
    </div>

    <script>
        // 全部互動功能
        document.addEventListener('DOMContentLoaded', function () {
            // 檢測檔案類型的輔助函數（全域函數）
            window.isVideoFile = function (dataUrl) {
                return dataUrl && dataUrl.startsWith('data:video/');
            };

            // 作業廠商與作業人員連動
            // 取得正確的作業廠商與作業人員 select
            const selects = document.querySelectorAll('#dutyRecordBlock select');
            // 0: 案件類型, 1: 作業廠商, 2: 作業人員
            const vendorSelect2 = selects[1];
            const staffSelect2 = selects[2];
            // 假設廠商A、B各自有不同人員
            const vendorStaffMap = {
                '廠商A': ['許ＯＯ', '陳ＯＯ'],
                '廠商B': ['李ＯＯ', '陳ＯＯ', '周ＯＯ'],
                '請選擇': []
            };
            function updateStaffOptions() {
                if (!vendorSelect2 || !staffSelect2) return;
                const vendor = vendorSelect2.value;
                let staffList = vendorStaffMap[vendor] || [];
                // 如果有人員清單，預設選擇第一個人員
                let options = [];
                if (staffList.length > 0) {
                    options.push(`<option>請選擇</option>`);
                    staffList.forEach((s, index) => {
                        if (index === 0) {
                            options.push(`<option selected>${s}</option>`);
                        } else {
                            options.push(`<option>${s}</option>`);
                        }
                    });
                } else {
                    options = [`<option selected>請選擇</option>`];
                }
                staffSelect2.innerHTML = options.join('');
            }
            if (vendorSelect2) {
                vendorSelect2.addEventListener('change', function () {
                    updateStaffOptions();
                });
                // 頁面載入時也執行一次
                updateStaffOptions();
            }
            // 指派案件驗證作業廠商與作業人員
            const assignCaseBtn = document.getElementById('assignCaseBtn');
            if (assignCaseBtn) {
                assignCaseBtn.addEventListener('click', function (e) {
                    let vendorValue = '';
                    let staffValue = '';
                    if (vendorSelect2) vendorValue = vendorSelect2.value;
                    if (staffSelect2) staffValue = staffSelect2.value;

                    // 只有在沒有選擇或是預設值時才提示
                    if (!vendorValue || vendorValue === '請選擇' || vendorValue === '') {
                        alert('請選擇作業廠商');
                        return;
                    }
                    if (!staffValue || staffValue === '請選擇' || staffValue === '') {
                        alert('請選擇作業人員');
                        return;
                    }
                    // 自動填入現在時間到廠商聯繫通報人時間欄位
                    const vendorContactTimeInput = document.querySelector('#dutyRecordBlock input[type="text"]');
                    if (vendorContactTimeInput) {
                        const now = new Date();
                        const yyyy = now.getFullYear();
                        const mm = String(now.getMonth() + 1).padStart(2, '0');
                        const dd = String(now.getDate()).padStart(2, '0');
                        const hh = String(now.getHours()).padStart(2, '0');
                        const min = String(now.getMinutes()).padStart(2, '0');
                        const ss = String(now.getSeconds()).padStart(2, '0');
                        vendorContactTimeInput.value = `${yyyy}/${mm}/${dd} ${hh}:${min}:${ss}`;
                    }
                    // 檢查內勤三個欄位是否符合案件取消條件
                    const dutyHasOwner = document.querySelector('input[name="hasOwner"]:checked')?.value;
                    const dutyReporterOnSite = document.querySelector('input[name="waitOnSite"]:checked')?.value;
                    const dutyStillOnSite = document.querySelector('input[name="stillOnSite"]:checked')?.value;
                    const shouldCancelCase = (dutyHasOwner === '是') || (dutyReporterOnSite === '否') || (dutyStillOnSite === '否');

                    if (shouldCancelCase) {
                        // 案件取消流程
                        const assignBtn = document.getElementById('assignCaseBtn');
                        if (assignBtn) {
                            assignBtn.innerHTML = '<i class="fas fa-times-circle w-3.5 h-3.5 mr-1"></i>案件取消';
                            assignBtn.type = 'submit';
                        }
                        // 顯示案件取消提示
                        alert('符合案件取消條件，案件將被取消');
                    } else {
                        // 正常指派流程
                        // 顯示外勤作業紀錄區塊
                        const fieldWorkBlock = document.getElementById('fieldWorkBlock');
                        if (fieldWorkBlock) fieldWorkBlock.style.display = '';
                        // 顯示後送作業紀錄區塊
                        const transferSection = document.getElementById('transferSection');
                        if (transferSection) transferSection.style.display = '';
                        // 顯示電子簽章區塊
                        const signatureBlock = document.getElementById('signatureBlock');
                        if (signatureBlock) signatureBlock.style.display = '';
                        // 將指派案件按鈕變成回報完成
                        const assignBtn = document.getElementById('assignCaseBtn');
                        if (assignBtn) {
                            assignBtn.innerHTML = '<i class="fas fa-check-circle w-3.5 h-3.5 mr-1"></i>回報完成';
                            assignBtn.type = 'submit';
                        }
                        // (已移除倒數計時條功能)
                    }
                });
            }
            // 回報完成處理（已移除驗證）
            const assignBtn = document.getElementById('assignCaseBtn');
            if (assignBtn) {
                assignBtn.addEventListener('click', function (e) {
                    if (assignBtn.type === 'submit' && assignBtn.innerText.includes('回報完成')) {
                        // 直接顯示完成案件視窗，不進行驗證
                        e.preventDefault();
                        showCompleteCaseModal();
                    } else if (assignBtn.type === 'submit' && assignBtn.innerText.includes('案件取消')) {
                        // 案件取消處理
                        e.preventDefault();
                        if (confirm('確定要取消此案件嗎？')) {
                            alert('案件已取消');
                            window.location.href = 'DutyCaseManagement_List.html';
                        }
                    }
                }, true);
            }
            // 完成案件視窗
            function showCompleteCaseModal() {
                let modal = document.getElementById('completeCaseModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'completeCaseModal';
                    modal.style.position = 'fixed';
                    modal.style.top = '0';
                    modal.style.left = '0';
                    modal.style.width = '100vw';
                    modal.style.height = '100vh';
                    modal.style.background = 'rgba(0,0,0,0.5)';
                    modal.style.display = 'flex';
                    modal.style.justifyContent = 'center';
                    modal.style.alignItems = 'center';
                    modal.style.zIndex = '9999';
                    modal.innerHTML = `
                        <div style='background:#fff;padding:32px 40px;border-radius:12px;box-shadow:0 2px 16px #0008;text-align:center;min-width:320px;'>
                            <h2 style='font-size:1.5rem;font-weight:bold;margin-bottom:16px;'>案件已完成</h2>
                            <p style='margin-bottom:24px;'>所有外勤作業紀錄已填寫，案件完成！</p>
                            <button id='closeCompleteCaseModalBtn' style='background:#198754;color:#fff;padding:8px 24px;border:none;border-radius:6px;font-size:1rem;font-weight:bold;cursor:pointer;'>確定</button>
                        </div>
                    `;
                    document.body.appendChild(modal);
                    document.getElementById('closeCompleteCaseModalBtn').onclick = function () {
                        window.location.href = 'DutyCaseManagement_List.html';
                    };
                } else {
                    modal.style.display = 'flex';
                }
            }
            // 屏東市/鄉鎮下拉選單控制
            const citySelect = document.querySelector('select.border-r');
            const townSelect = document.querySelector('select.rounded-r');
            if (citySelect && townSelect) {
                function updateTownVisibility() {
                    if (citySelect.value === '屏東市') {
                        townSelect.style.display = 'none';
                    } else {
                        townSelect.style.display = '';
                    }
                }
                citySelect.addEventListener('change', updateTownVisibility);
                updateTownVisibility();
            }

            // 案件類型與物種聯動
            const caseTypeSelect = document.getElementById('caseTypeSelect');
            const speciesSelect = document.getElementById('speciesSelect');
            // 關聯設定
            const speciesOptionsMap = {
                '補蜂': ['蜜蜂', '虎頭蜂', '游離蜂', '泥壺蜂'],
                '捉蛇': ['蛇類(保育)', '蛇類(一般)'],
                '動物救援': ['犬', '貓', '經濟動物', '其他寵物', '野生動物(一般)', '野生動物(保育)'],
                '綠鬣蜥': ['綠鬣蜥']
            };
            function updateSpeciesOptionsByCaseType() {
                if (!caseTypeSelect || !speciesSelect) return;
                const type = caseTypeSelect.value;
                const options = speciesOptionsMap[type] || [];
                speciesSelect.innerHTML = options.map(o => `<option>${o}</option>`).join('');
                speciesSelect.value = options[0] || '';
                updateProcessOptions && updateProcessOptions();
                updateWorkPhotoTips && updateWorkPhotoTips();
            }
            if (caseTypeSelect) {
                caseTypeSelect.addEventListener('change', updateSpeciesOptionsByCaseType);
                updateSpeciesOptionsByCaseType();
            }
            if (speciesSelect) {
                speciesSelect.addEventListener('change', function () {
                    updateProcessOptions && updateProcessOptions();
                    updateWorkPhotoTips && updateWorkPhotoTips();
                });
            }

            // 內勤作業物種名稱與通報資料案件類型聯動
            const basicCaseTypeSelect = document.getElementById('basicCaseTypeSelect');
            const dutySpeciesSelect = document.getElementById('dutySpeciesSelect');
            const fieldSpeciesSelect = document.getElementById('fieldSpeciesSelect');

            function updateDutySpeciesOptions() {
                if (!basicCaseTypeSelect || !dutySpeciesSelect) return;
                const type = basicCaseTypeSelect.value;
                const options = speciesOptionsMap[type] || [];

                // 根據案件類型更新內勤作業的物種選項
                let dutyOptions = ['請選擇'];
                if (options.length > 0) {
                    dutyOptions = dutyOptions.concat(options);
                } else {
                    // 如果沒有對應的物種，保留原有的通用選項
                    dutyOptions = dutyOptions.concat(['眼鏡蛇', '虎頭蜂', '長腳蜂', '球蟒', '白鼻心', '綠鬣蜥']);
                }

                dutySpeciesSelect.innerHTML = dutyOptions.map((o, i) =>
                    `<option${i === 1 ? ' selected' : ''}>${o}</option>`
                ).join('');

                // 同步更新外勤物種名稱
                if (fieldSpeciesSelect) {
                    fieldSpeciesSelect.innerHTML = dutyOptions.map((o, i) =>
                        `<option${i === 1 ? ' selected' : ''}>${o}</option>`
                    ).join('');
                }
            }

            // 內勤物種名稱變更時，同步外勤物種名稱
            function syncSpeciesSelection() {
                if (dutySpeciesSelect && fieldSpeciesSelect) {
                    fieldSpeciesSelect.value = dutySpeciesSelect.value;
                }
            }

            if (basicCaseTypeSelect) {
                basicCaseTypeSelect.addEventListener('change', updateDutySpeciesOptions);
                // 頁面載入時執行一次
                updateDutySpeciesOptions();
            }

            if (dutySpeciesSelect) {
                dutySpeciesSelect.addEventListener('change', syncSpeciesSelection);
            }

            // 處理情形動態調整
            function updateProcessOptions() {
                const caseTypeSelect = document.getElementById('caseTypeSelect');
                const speciesSelect = document.getElementById('speciesSelect');
                const statusSelect_main = document.getElementById('speciesStatusSelect');
                const processSelect = document.getElementById('processSelect');
                const fieldProcessSelect = document.getElementById('fieldProcessSelect');
                const processLabel_main = document.getElementById('processLabel');
                const processStar_main = processLabel_main ? processLabel_main.querySelector('.text-danger') : null;
                const workPhotoBlock3 = document.getElementById('workPhotoBlock3');
                const workPhotoBlock2Star = document.querySelector('#workPhotoBlock2 .work-photo-title .text-danger');
                const transferSection = document.getElementById('transferSection');

                if (workPhotoBlock2Star) workPhotoBlock2Star.style.display = 'none';
                if (!speciesSelect || !statusSelect_main || !processSelect) return;

                const caseType = caseTypeSelect?.value;
                const species = speciesSelect.value;
                const status = statusSelect_main.value;
                let options = [];
                let required = true;

                // 如果案件類型是補蜂，使用特殊的處理情形選項
                if (caseType === '補蜂') {
                    options = ['銷毀、驅離', '攜回'];
                } else if (caseType === '捉蛇') {
                    // 捉蛇案件根據物種狀況決定處理情形
                    if (status === '健康') {
                        options = ['攜回'];
                    } else if (status === '受傷') {
                        options = ['後送'];
                    } else if (status === '到場前已自行逃脫') {
                        options = ['到場前已自行脫逃'];
                    } else {
                        // 如果還沒選擇狀況，顯示所有可能選項
                        options = ['攜回', '後送', '到場前已自行脫逃'];
                    }
                } else if (caseType === '綠鬣蜥') {
                    // 綠鬣蜥案件的處理情形
                    options = ['捕獲', '未捕獲'];
                } else if (caseType === '動物救援' && (species === '犬' || species === '貓' || species === '經濟動物' || species === '其他寵物')) {
                    // 犬貓、經濟動物和其他寵物案件的處理情形 - 依有無飼主與現場狀況動態決定
                    const dogCatOwnerBlock = document.getElementById('dogCatOwnerBlock');
                    const dogCatPaymentBlock = document.getElementById('dogCatPaymentBlock');
                    const ownerSelect = document.getElementById('dogCatOwnerSelect');
                    // 刪除到場前已逃跑欄位
                    const strayEscapeBlock = document.getElementById('strayEscapeBlock');
                    if (strayEscapeBlock) strayEscapeBlock.remove();
                    // 刪除脫困能力欄位
                    const strayTrappedAbilityBlock = document.getElementById('strayTrappedAbilityBlock');
                    if (strayTrappedAbilityBlock) strayTrappedAbilityBlock.remove();
                    // 取得欄位值
                    const hasOwner = ownerSelect?.value;
                    const speciesStatus = statusSelect_main.value;
                    // 顯示/隱藏欄位
                    if (dogCatOwnerBlock) dogCatOwnerBlock.style.display = '';
                    if (hasOwner === '是') {
                        // 有飼主
                        if (dogCatPaymentBlock) dogCatPaymentBlock.style.display = 'none';
                        options = ['飼主處理', '到場無法救援', '到場無動物', '棄養'];
                    } else if (hasOwner === '否') {
                        // 無飼主（流浪）
                        if (speciesStatus === '受傷') {
                            // 顯示通報人支付費用欄位
                            if (dogCatPaymentBlock) dogCatPaymentBlock.style.display = '';
                            const paymentSelect = document.getElementById('dogCatPaymentSelect');
                            const payment = paymentSelect?.value;

                            if (payment === '是') {
                                options = ['後送', '到場無法救援', '到場無動物', '棄養'];
                            } else if (payment === '否') {
                                options = ['安全處野放', '到場無法救援', '到場無動物', '棄養'];
                            } else {
                                options = ['到場無法救援', '到場無動物', '棄養'];
                            }
                        } else if (speciesStatus === '健康') {
                            if (dogCatPaymentBlock) dogCatPaymentBlock.style.display = 'none';
                            options = ['安全處野放', '到場無法救援', '到場無動物', '棄養'];
                        } else {
                            if (dogCatPaymentBlock) dogCatPaymentBlock.style.display = 'none';
                            options = ['到場無法救援', '到場無動物', '棄養'];
                        }
                    } else {
                        // 尚未選擇有無飼主
                        if (dogCatPaymentBlock) dogCatPaymentBlock.style.display = 'none';
                        options = ['到場無法救援', '到場無動物', '棄養'];
                    }
                    // 綁定事件
                    if (ownerSelect) ownerSelect.onchange = updateProcessOptions;
                    if (document.getElementById('dogCatPaymentSelect')) document.getElementById('dogCatPaymentSelect').onchange = updateProcessOptions;
                } else if (species === '野生動物(一般)') {
                    // 野生動物(一般)的處理邏輯
                    if (status === '受傷') {
                        // 受傷 = 後送(動物之家)
                        options = ['後送'];
                    } else if (status === '健康') {
                        // 健康的野生動物
                        options = ['安全處野放', '攜回(外來種)'];
                    } else {
                        // 其他狀況，包含所有選項
                        options = ['已逃跑', '安全處野放', '後送', '攜回(外來種)'];
                    }
                } else if (species === '野生動物(保育)') {
                    // 野生動物(保育)的處理邏輯
                    if (status === '受傷') {
                        options = ['後送'];
                    } else if (status === '健康') {
                        options = ['安全處野放'];
                    } else {
                        // 其他狀況，包含所有選項
                        options = ['已逃跑', '安全處野放', '後送'];
                    }
                } else {
                    options = ['已逃跑', '現場放走', '野放', '後送'];
                }

                // 隱藏犬貓、經濟動物和其他寵物專用欄位（如果不是這些案件類型）
                if (!(caseType === '動物救援' && (species === '犬' || species === '貓' || species === '經濟動物' || species === '其他寵物'))) {
                    const dogCatOwnerBlock = document.getElementById('dogCatOwnerBlock');
                    const dogCatPaymentBlock = document.getElementById('dogCatPaymentBlock');
                    if (dogCatOwnerBlock) dogCatOwnerBlock.style.display = 'none';
                    if (dogCatPaymentBlock) dogCatPaymentBlock.style.display = 'none';
                }

                processSelect.innerHTML = options.map((o, i) => `<option${i === 0 ? ' selected' : ''}>${o}</option>`).join('');
                if (processStar_main) processStar_main.style.display = required ? '' : 'none';
                // 三個區塊都要顯示
                if (workPhotoBlock3) workPhotoBlock3.style.display = '';

                // 顯示/隱藏後送文字欄位並自動填入內容
                const transferInput = document.getElementById('transferHospitalInput');
                if (transferInput && processSelect.value === '後送') {
                    transferInput.style.display = '';
                    // 根據案件類型和物種自動填入文字
                    if (caseType === '捉蛇') {
                        if (species === '蛇類(保育)') {
                            transferInput.value = '屏科大';
                        } else if (species === '蛇類(一般)') {
                            transferInput.value = '動物醫院';
                        } else {
                            transferInput.value = '移送指定動物醫院/單位';
                        }
                    } else if (caseType === '動物救援' && (species === '犬' || species === '貓' || species === '經濟動物' || species === '其他寵物')) {
                        // 犬貓、經濟動物和其他寵物案件後送到動物之家
                        transferInput.value = '動物之家';
                    } else if (caseType === '動物救援' && species === '野生動物(保育)') {
                        // 保育類野生動物後送到屏科大
                        transferInput.value = '屏科大';
                    } else if (caseType === '動物救援' && species === '野生動物(一般)') {
                        // 一般野生動物根據狀況決定後送地點
                        const speciesStatus = document.getElementById('speciesStatusSelect')?.value;
                        if (speciesStatus === '受傷') {
                            transferInput.value = '動物之家';
                        } else {
                            transferInput.value = '動物醫院';
                        }
                    } else {
                        transferInput.value = '移送指定動物醫院/單位';
                    }
                } else if (transferInput) {
                    transferInput.style.display = 'none';
                }
            }
            // 綁定事件時直接取得元素，避免重複宣告
            if (document.getElementById('caseTypeSelect')) document.getElementById('caseTypeSelect').addEventListener('change', updateProcessOptions);
            if (document.getElementById('speciesSelect')) document.getElementById('speciesSelect').addEventListener('change', updateProcessOptions);
            if (document.getElementById('speciesStatusSelect')) document.getElementById('speciesStatusSelect').addEventListener('change', updateProcessOptions);
            if (document.getElementById('dogCatOwnerSelect')) document.getElementById('dogCatOwnerSelect').addEventListener('change', updateProcessOptions);
            if (document.getElementById('dogCatPaymentSelect')) document.getElementById('dogCatPaymentSelect').addEventListener('change', updateProcessOptions);
            if (document.getElementById('processSelect')) document.getElementById('processSelect').addEventListener('change', function () {
                const workPhotoBlock3 = document.getElementById('workPhotoBlock3');
                if (workPhotoBlock3) workPhotoBlock3.style.display = '';
                // 顯示/隱藏後送文字欄位並自動填入內容
                const transferInput = document.getElementById('transferHospitalInput');
                if (transferInput && this.value === '後送') {
                    transferInput.style.display = '';
                    // 根據案件類型和物種自動填入文字
                    const caseTypeSelect = document.getElementById('caseTypeSelect');
                    const speciesSelect = document.getElementById('speciesSelect');
                    const caseType = caseTypeSelect?.value;
                    const species = speciesSelect?.value;

                    if (caseType === '捉蛇') {
                        if (species === '蛇類(保育)') {
                            transferInput.value = '屏科大';
                        } else if (species === '蛇類(一般)') {
                            transferInput.value = '動物醫院';
                        } else {
                            transferInput.value = '移送指定動物醫院/單位';
                        }
                    } else if (caseType === '動物救援' && (species === '犬' || species === '貓' || species === '經濟動物')) {
                        // 犬貓和經濟動物案件後送到動物之家
                        transferInput.value = '動物之家';
                    } else if (caseType === '動物救援' && species === '野生動物(保育)') {
                        // 保育類野生動物後送到屏科大
                        transferInput.value = '屏科大';
                    } else if (caseType === '動物救援' && species === '野生動物(一般)') {
                        // 一般野生動物根據狀況決定後送地點
                        const speciesStatus = document.getElementById('speciesStatusSelect')?.value;
                        if (speciesStatus === '受傷') {
                            transferInput.value = '動物之家';
                        } else {
                            transferInput.value = '動物醫院';
                        }
                    } else {
                        transferInput.value = '移送指定動物醫院/單位';
                    }
                } else if (transferInput) {
                    transferInput.style.display = 'none';
                }
            });
            updateProcessOptions();

            // 物種狀況管理
            const statusSelect_cascade = document.getElementById('speciesStatusSelect');
            const star = document.getElementById('speciesStatusStar');
            const processLabel_cascade = document.getElementById('processLabel');
            const processStar_cascade = processLabel_cascade ? processLabel_cascade.querySelector('.text-danger') : null;
            const photoStars = document.querySelectorAll('.work-photo-title .text-danger');
            function updateRequiredFields(status) {
                if (status === '到場前已自行逃脫') {
                    if (processStar_cascade) processStar_cascade.style.display = 'none';
                    if (star) star.style.display = 'none';
                    photoStars.forEach(function (s) { s.style.display = 'none'; });
                } else {
                    if (processStar_cascade) processStar_cascade.style.display = '';
                    if (star) star.style.display = '';
                    photoStars.forEach(function (s) { s.style.display = ''; });
                }
            }
            if (statusSelect_cascade) {
                statusSelect_cascade.addEventListener('change', function () {
                    updateRequiredFields(this.value);
                    updateProcessOptions();
                });
            }

            // 照片上傳和預覽功能（支援多選）
            function setupPhotoUpload(blockId, inputId, previewId) {
                let modal = document.getElementById('photoModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'photoModal';
                    modal.style.position = 'fixed';
                    modal.style.top = '0';
                    modal.style.left = '0';
                    modal.style.width = '100vw';
                    modal.style.height = '100vh';
                    modal.style.background = 'rgba(0,0,0.7)';
                    modal.style.display = 'none';

                    modal.style.justifyContent = 'center';
                    modal.style.alignItems = 'center';
                    modal.style.zIndex = '9999';
                    modal.innerHTML = `
                        <div id='photoModalTitle' style='position:absolute;top:32px;left:32px;color:#fff;font-size:1.25rem;font-weight:bold;text-shadow:0 2px 8px #000a;'></div>
                        <button id='photoModalCloseBtn' style='position:absolute;top:32px;right:32px;background:#fff;border:none;border-radius:50%;width:40px;height:40px;box-shadow:0 2px 8px #0004;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1.5rem;'>×</button>
                        <button id='photoModalPrevBtn' style='position:absolute;left:16px;top:50%;transform:translateY(-50%);background:#fff;border:none;border-radius:50%;width:40px;height:40px;box-shadow:0 2px 8px #0004;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:2rem;'>&lt;</button>
                        <button id='photoModalNextBtn' style='position:absolute;right:16px;top:50%;transform:translateY(-50%);background:#fff;border:none;border-radius:50%;width:40px;height:40px;box-shadow:0 2px 8px #0004;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:2rem;'>&gt;</button>
                        <img id="photoModalImg" style="max-width:90vw;max-height:90vh;border-radius:12px;box-shadow:0 2px 16px #0008;display:none;" />
                        <video id="photoModalVideo" controls style="max-width:90vw;max-height:90vh;border-radius:12px;box-shadow:0 2px 16px #0008;display:none;" preload="metadata"></video>
                    `;
                    document.body.appendChild(modal);

                    // 添加延遲以防止立即關閉
                    let modalJustOpened = false;

                    modal.addEventListener('click', function (e) {
                        // 如果模態框剛開啟，忽略點擊事件
                        if (modalJustOpened) {
                            return;
                        }

                        // 只有點擊背景時才關閉（不是按鈕或媒體元素）
                        if (e.target === modal) {
                            console.log('Closing modal via background click');
                            modal.style.display = 'none';
                        }
                    });

                    document.getElementById('photoModalCloseBtn').onclick = function (e) {
                        console.log('Closing modal via close button');
                        modal.style.display = 'none';
                        e.stopPropagation();
                    };
                }

                const uploadBtn = document.getElementById(inputId);
                const previewBox = document.getElementById(previewId);
                const blockIdx = blockId === 'workPhotoBlock1' ? 0 : blockId === 'workPhotoBlock2' ? 1 : 2;
                const countSpan = document.getElementById(`photoCount${blockIdx + 1}`);

                if (!uploadBtn || !previewBox) return;

                // 初始化多照片存儲
                if (!window.workPhotoDataMulti) {
                    window.workPhotoDataMulti = [[], [], []]; // 每個階段最多4張照片
                    window.workPhotoTitles = ["處理前紀錄", "處理中紀錄", "處理完成紀錄"];
                }

                // 更新照片計數和上傳按鈕顯示狀態
                function updateDisplay() {
                    const photos = window.workPhotoDataMulti[blockIdx];
                    const photoCount = photos.length;

                    // 更新計數
                    if (countSpan) {
                        countSpan.textContent = photoCount;
                    }

                    // 獲取固定的照片位置槽和上傳按鈕
                    const photoSlots = previewBox.querySelectorAll('.photo-slot');
                    const uploadSlot = previewBox.querySelector('.upload-slot');

                    // 更新每個照片位置（現在有4個位置）
                    photoSlots.forEach((slot, index) => {
                        const img = slot.querySelector('img');
                        const deleteBtn = slot.querySelector('button');
                        let video = slot.querySelector('video');

                        if (index < photoCount && photos[index]) {
                            slot.style.display = 'block';

                            // 檢查檔案類型
                            if (window.isVideoFile && window.isVideoFile(photos[index])) {
                                // 處理影片檔案
                                if (img) img.style.display = 'none';

                                if (!video) {
                                    video = document.createElement('video');
                                    video.className = 'w-full h-full object-cover rounded';
                                    video.controls = true;
                                    video.preload = 'metadata';
                                    video.style.position = 'relative';
                                    slot.insertBefore(video, deleteBtn);

                                    // 創建放大按鈕
                                    const expandBtn = document.createElement('button');
                                    expandBtn.innerHTML = '⛶';
                                    expandBtn.className = 'video-expand-btn';
                                    expandBtn.style.position = 'absolute';
                                    expandBtn.style.top = '8px';
                                    expandBtn.style.left = '8px';
                                    expandBtn.style.width = '24px';
                                    expandBtn.style.height = '24px';
                                    expandBtn.style.backgroundColor = 'rgba(0,0,0,0.7)';
                                    expandBtn.style.color = 'white';
                                    expandBtn.style.border = 'none';
                                    expandBtn.style.borderRadius = '4px';
                                    expandBtn.style.cursor = 'pointer';
                                    expandBtn.style.fontSize = '12px';
                                    expandBtn.style.zIndex = '15';
                                    expandBtn.style.display = 'flex';
                                    expandBtn.style.alignItems = 'center';
                                    expandBtn.style.justifyContent = 'center';
                                    expandBtn.title = '全螢幕查看';
                                    slot.appendChild(expandBtn);
                                }

                                video.style.display = 'block';
                                video.src = photos[index];

                                // 確保影片可以正確載入和播放
                                video.load(); // 重新載入影片

                                // 添加影片載入事件監聽器
                                video.onloadeddata = function () {
                                    console.log('Preview video loaded successfully');
                                };

                                video.onerror = function (e) {
                                    console.error('Preview video loading error:', e);
                                };

                                // 為放大按鈕添加點擊事件
                                const expandBtn = slot.querySelector('.video-expand-btn');
                                if (expandBtn) {
                                    expandBtn.onclick = (e) => {
                                        e.preventDefault();
                                        e.stopPropagation();
                                        e.stopImmediatePropagation();

                                        console.log('Expand button clicked');

                                        if (window.showPhotoModal) {
                                            // 延遲一點時間再打開模態框
                                            setTimeout(() => {
                                                window.showPhotoModal(blockIdx, index);
                                            }, 100);
                                        }
                                    };
                                }
                            } else {
                                // 處理圖片檔案
                                if (video) video.style.display = 'none';

                                // 移除影片放大按鈕
                                const expandBtn = slot.querySelector('.video-expand-btn');
                                if (expandBtn) expandBtn.remove();

                                img.style.display = 'block';
                                img.src = photos[index];
                                img.onclick = (e) => {
                                    e.preventDefault();
                                    e.stopPropagation();

                                    if (window.showPhotoModal) {
                                        setTimeout(() => {
                                            window.showPhotoModal(blockIdx, index);
                                        }, 100);
                                    }
                                };
                            }

                            deleteBtn.onclick = (e) => {
                                e.stopPropagation();
                                removePhoto(blockIdx, index);
                            };
                        } else {
                            // 隱藏空位置
                            slot.style.display = 'none';
                        }
                    });

                    // 控制上傳按鈕的顯示
                    const isVideoMode = uploadBtn.getAttribute('accept') === 'video/*';
                    const maxFiles = isVideoMode ? 1 : 4;

                    if (photoCount < maxFiles) {
                        uploadSlot.style.display = 'flex';
                    } else {
                        uploadSlot.style.display = 'none';
                    }
                }

                // 移除照片函數
                function removePhoto(blockIdx, photoIdx) {
                    window.workPhotoDataMulti[blockIdx].splice(photoIdx, 1);
                    updateDisplay();
                }

                uploadBtn.addEventListener('change', function (e) {
                    const files = Array.from(e.target.files);
                    const currentPhotos = window.workPhotoDataMulti[blockIdx];

                    // 檢查當前是否為影片模式
                    const isVideoMode = uploadBtn.getAttribute('accept') === 'video/*';
                    const maxFiles = isVideoMode ? 1 : 4;
                    const fileType = isVideoMode ? '影片' : '照片';

                    // 檢查是否超過限制
                    if (currentPhotos.length + files.length > maxFiles) {
                        alert(`每個階段最多只能上傳${maxFiles}個${fileType}，目前已有${currentPhotos.length}個，最多還能上傳${maxFiles - currentPhotos.length}個。`);
                        e.target.value = ''; // 清空選擇
                        return;
                    }

                    // 處理每個檔案
                    let processedCount = 0;
                    files.forEach(file => {
                        const isImage = file.type.startsWith('image/');
                        const isVideo = file.type.startsWith('video/');

                        if (!isImage && !isVideo) {
                            alert(`檔案 ${file.name} 格式不支援，請選擇圖片或影片檔案。`);
                            return;
                        }

                        // 暫時移除檔案大小限制
                        // const maxSize = isVideo ? 10 * 1024 * 1024 : 2 * 1024 * 1024; // 影片10MB，照片2MB
                        // const sizeText = isVideo ? '10MB' : '2MB';

                        // if (file.size > maxSize) {
                        //     alert(`檔案 ${file.name} 超過${sizeText}大小限制。`);
                        //     return;
                        // }

                        const reader = new FileReader();
                        reader.onload = function (evt) {
                            window.workPhotoDataMulti[blockIdx].push(evt.target.result);
                            processedCount++;

                            // 當所有檔案都處理完成時更新顯示
                            if (processedCount === files.length) {
                                updateDisplay();
                            }
                        };
                        reader.readAsDataURL(file);
                    });

                    // 清空input以允許重複選擇相同檔案
                    e.target.value = '';
                });

                // 初始化模態視窗功能
                if (!window.photoModalSliderInit) {
                    window.photoModalSliderInit = true;
                    window.currentPhotoBlockIdx = 0;
                    window.currentPhotoIdx = 0;

                    window.showPhotoModal = function (blockIdx, photoIdx = 0) {
                        try {
                            console.log('Opening photo modal:', { blockIdx, photoIdx });

                            // 確保模態框存在
                            const modal = document.getElementById("photoModal");
                            if (!modal) {
                                console.error('Photo modal not found');
                                return;
                            }

                            window.currentPhotoBlockIdx = blockIdx;
                            window.currentPhotoIdx = photoIdx;
                            updatePhotoModal();

                            // 設置防止立即關閉的標誌
                            modalJustOpened = true;
                            modal.style.display = "flex";

                            // 500ms 後允許背景點擊關閉
                            setTimeout(() => {
                                modalJustOpened = false;
                            }, 500);

                        } catch (error) {
                            console.error('Error in showPhotoModal:', error);
                        }
                    };

                    function updatePhotoModal() {
                        try {
                            const img = document.getElementById("photoModalImg");
                            const video = document.getElementById("photoModalVideo");
                            const title = document.getElementById("photoModalTitle");
                            if (!img || !video || !title) {
                                console.error('Modal elements not found:', { img: !!img, video: !!video, title: !!title });
                                return;
                            }

                            const photos = window.workPhotoDataMulti[window.currentPhotoBlockIdx];
                            const titlesArr = window.workPhotoTitles;

                            if (photos && photos.length > 0 && photos[window.currentPhotoIdx]) {
                                const currentFile = photos[window.currentPhotoIdx];
                                title.textContent = `${titlesArr[window.currentPhotoBlockIdx]} (${window.currentPhotoIdx + 1}/${photos.length})`;

                                if (window.isVideoFile && window.isVideoFile(currentFile)) {
                                    // 顯示影片，隱藏圖片
                                    console.log('Displaying video in modal:', currentFile.substring(0, 50) + '...');
                                    img.style.display = 'none';
                                    video.style.display = 'block';
                                    video.src = currentFile;

                                    // 確保影片可以播放
                                    video.load(); // 重新載入影片
                                    video.setAttribute('controlsList', 'nodownload'); // 移除下載按鈕（可選）

                                    // 添加影片載入事件監聽器
                                    video.onloadeddata = function () {
                                        console.log('Video loaded successfully');
                                    };

                                    video.onerror = function (e) {
                                        console.error('Video loading error:', e);
                                    };
                                } else {
                                    // 顯示圖片，隱藏影片
                                    video.style.display = 'none';
                                    img.style.display = 'block';
                                    img.src = currentFile;
                                }
                            } else {
                                img.style.display = 'none';
                                video.style.display = 'none';
                                img.src = '';
                                video.src = '';
                                title.textContent = '';
                            }
                        } catch (error) {
                            console.error('Error in updatePhotoModal:', error);
                        }
                    }

                    document.getElementById('photoModalPrevBtn').onclick = function (e) {
                        e.stopPropagation();
                        const photos = window.workPhotoDataMulti[window.currentPhotoBlockIdx];
                        if (photos && photos.length > 0) {
                            window.currentPhotoIdx = (window.currentPhotoIdx - 1 + photos.length) % photos.length;
                            updatePhotoModal();
                        }
                    };

                    document.getElementById('photoModalNextBtn').onclick = function (e) {
                        e.stopPropagation();
                        const photos = window.workPhotoDataMulti[window.currentPhotoBlockIdx];
                        if (photos && photos.length > 0) {
                            window.currentPhotoIdx = (window.currentPhotoIdx + 1) % photos.length;
                            updatePhotoModal();
                        }
                    };
                }

                // 初始化顯示
                updateDisplay();
            }
            setupPhotoUpload('workPhotoBlock1', 'workPhotoInput1', 'workPhotoPreview1');
            setupPhotoUpload('workPhotoBlock2', 'workPhotoInput2', 'workPhotoPreview2');
            setupPhotoUpload('workPhotoBlock3', 'workPhotoInput3', 'workPhotoPreview3');

            // 動態檔案上傳限制
            function updateWorkPhotoTips() {
                const tip1 = document.getElementById('workPhotoTip1');
                const tip2 = document.getElementById('workPhotoTip2');
                const tip3 = document.getElementById('workPhotoTip3');
                const input1 = document.getElementById('workPhotoInput1');
                const input2 = document.getElementById('workPhotoInput2');
                const input3 = document.getElementById('workPhotoInput3');

                // 取得上傳按鈕中的文字元素
                const uploadText1 = document.querySelector('label[for="workPhotoInput1"] .text-xs');
                const uploadText2 = document.querySelector('label[for="workPhotoInput2"] .text-xs');
                const uploadText3 = document.querySelector('label[for="workPhotoInput3"] .text-xs');

                // 判斷案件類型與物種
                const type = caseTypeSelect?.value;
                const species = speciesSelect?.value;
                if (type === '補蜂' && (species === '游離蜂' || species === '泥壺蜂')) {
                    // 設定為影片上傳
                    if (tip1) tip1.textContent = '可上傳的檔案格式：mp4、mov、avi，最多1個。';
                    if (tip2) tip2.textContent = '可上傳的檔案格式：mp4、mov、avi，最多1個。';
                    if (tip3) tip3.textContent = '可上傳的檔案格式：mp4、mov、avi，最多1個。';
                    if (input1) input1.setAttribute('accept', 'video/*');
                    if (input2) input2.setAttribute('accept', 'video/*');
                    if (input3) input3.setAttribute('accept', 'video/*');
                    if (uploadText1) uploadText1.textContent = '新增影片';
                    if (uploadText2) uploadText2.textContent = '新增影片';
                    if (uploadText3) uploadText3.textContent = '新增影片';
                } else {
                    // 設定為照片上傳
                    if (tip1) tip1.textContent = '可上傳的檔案格式：jpg、jpeg、png，最多4張。';
                    if (tip2) tip2.textContent = '可上傳的檔案格式：jpg、jpeg、png，最多4張。';
                    if (tip3) tip3.textContent = '可上傳的檔案格式：jpg、jpeg、png，最多4張。';
                    if (input1) input1.setAttribute('accept', 'image/*');
                    if (input2) input2.setAttribute('accept', 'image/*');
                    if (input3) input3.setAttribute('accept', 'image/*');
                    if (uploadText1) uploadText1.textContent = '新增照片';
                    if (uploadText2) uploadText2.textContent = '新增照片';
                    if (uploadText3) uploadText3.textContent = '新增照片';
                }
            }
            if (caseTypeSelect) caseTypeSelect.addEventListener('change', updateWorkPhotoTips);
            if (speciesSelect) speciesSelect.addEventListener('change', updateWorkPhotoTips);
            updateWorkPhotoTips();

            // 定位功能
            const locationBtn = document.getElementById('getLocationBtn');
            const locationField = document.getElementById('locationField');
            if (locationBtn && locationField) {
                locationBtn.addEventListener('click', function () {
                    console.log('定位按鈕已點擊');
                    const arriveTimeField = document.getElementById('arriveTimeField');
                    const now = new Date();
                    const yyyy = now.getFullYear();
                    const mm = String(now.getMonth() + 1).padStart(2, '0');
                    const dd = String(now.getDate()).padStart(2, '0');
                    const hh = String(now.getHours()).padStart(2, '0');
                    const min = String(now.getMinutes()).padStart(2, '0');
                    const ss = String(now.getSeconds()).padStart(2, '0');
                    const dateTimeStr = `${yyyy}/${mm}/${dd} ${hh}:${min}:${ss}`;
                    if (arriveTimeField) arriveTimeField.value = dateTimeStr;
                    locationField.focus();
                    if (!navigator.geolocation) {
                        locationField.value = '瀏覽器不支援定位';
                        return;
                    }
                    locationField.value = '定位中...';
                    navigator.geolocation.getCurrentPosition(
                        function (pos) {
                            locationField.value = pos.coords.latitude + ',' + pos.coords.longitude;
                            console.log('定位成功', pos.coords);
                        },
                        function (err) {
                            let msg = '無法取得定位';
                            if (err && err.message) msg += `: ${err.message}`;
                            locationField.value = msg;
                            console.log('定位失敗', err);
                        },
                        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                    );
                });
            }

            // 收合/展開功能
            const toggleBtn = document.getElementById('toggleBasicInfoBtn');
            const basicBlock = document.getElementById('basicInfoBlock');
            const toggleText = document.getElementById('toggleBasicInfoText');
            const toggleIcon = document.getElementById('toggleBasicInfoIcon');
            let isBasicInfoOpen = true;
            if (toggleBtn && basicBlock) {
                toggleBtn.addEventListener('click', function () {
                    isBasicInfoOpen = !isBasicInfoOpen;
                    if (isBasicInfoOpen) {
                        basicBlock.style.display = '';
                        toggleText.textContent = '收合';
                        toggleIcon.classList.remove('fa-chevron-down');
                        toggleIcon.classList.add('fa-chevron-up');
                    } else {
                        basicBlock.style.display = 'none';
                        toggleText.textContent = '展開';
                        toggleIcon.classList.remove('fa-chevron-up');
                        toggleIcon.classList.add('fa-chevron-down');
                    }
                });
            }

            const toggleDutyBtn = document.getElementById('toggleDutyRecordBtn');

            const dutyBlock = document.getElementById('dutyRecordBlock');
            const toggleDutyText = document.getElementById('toggleDutyRecordText');
            const toggleDutyIcon = document.getElementById('toggleDutyRecordIcon');
            let isDutyRecordOpen = true;
            if (toggleDutyBtn && dutyBlock) {
                toggleDutyBtn.addEventListener('click', function () {
                    isDutyRecordOpen = !isDutyRecordOpen;
                    if (isDutyRecordOpen) {
                        dutyBlock.style.display = '';
                        toggleDutyText.textContent = '收合';
                        toggleDutyIcon.classList.remove('fa-chevron-down');
                        toggleDutyIcon.classList.add('fa-chevron-up');
                    } else {
                        dutyBlock.style.display = 'none';
                        toggleDutyText.textContent = '展開';
                        toggleDutyIcon.classList.remove('fa-chevron-up');
                        toggleDutyIcon.classList.add('fa-chevron-down');
                    }
                });
            }

            // 手機選單收合
            const btn = document.getElementById('mobileMenuBtn');
            const menu = document.getElementById('mobileMenu');
            if (btn && menu) {
                btn.addEventListener('click', () => {
                    menu.classList.toggle('hidden');
                });
            }

            // 外勤處理情形監聽器 - 當選擇「後送」時顯示後送作業區塊
            const fieldProcessSelect = document.getElementById('fieldProcessSelect');
            if (fieldProcessSelect) {
                // 移除自動顯示隱藏邏輯，讓後送作業區塊始終可見
                fieldProcessSelect.addEventListener('change', function () {
                    // 可以在這裡添加其他邏輯，但不控制後送區塊的顯示隱藏
                });
            }            // 後送作業照片上傳功能
            const transferPhotoInput = document.getElementById('transferPhotoInput');
            const transferPhotoSlot = document.getElementById('transferPhotoSlot');
            const transferUploadSlot = document.getElementById('transferUploadSlot');
            const transferPhotoCount = document.getElementById('transferPhotoCount');

            if (transferPhotoInput) {
                transferPhotoInput.addEventListener('change', function (e) {
                    const file = e.target.files[0];
                    if (!file) return;

                    // 檢查檔案類型
                    if (!file.type.match('image.*')) {
                        alert('請選擇圖片檔案（jpg、jpeg、png）');
                        return;
                    }

                    // 檢查檔案大小（2MB）
                    if (file.size > 2 * 1024 * 1024) {
                        alert('檔案大小不能超過 2MB');
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const img = transferPhotoSlot.querySelector('img');
                        img.src = e.target.result;
                        transferPhotoSlot.style.display = 'block';
                        transferUploadSlot.style.display = 'none';
                        transferPhotoCount.textContent = '1';
                    };
                    reader.readAsDataURL(file);
                });
            }

            // 後送照片刪除功能
            if (transferPhotoSlot) {
                const deleteBtn = transferPhotoSlot.querySelector('button');
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', function () {
                        transferPhotoSlot.style.display = 'none';
                        transferUploadSlot.style.display = 'flex';
                        transferPhotoCount.textContent = '0';
                        if (transferPhotoInput) transferPhotoInput.value = '';
                    });
                }
            }

            // 電子簽章功能
            const openBtn = document.getElementById('openSignatureModalBtn');
            const signatureModal = document.getElementById('signatureModal');
            const closeBtn = document.getElementById('closeSignatureModalBtn');
            const previewDiv = document.getElementById('signaturePreview');
            let signatureDataURL = '';
            if (openBtn && signatureModal) {
                openBtn.onclick = function () {
                    signatureModal.classList.remove('hidden');
                };
            }
            if (closeBtn && signatureModal) {
                closeBtn.onclick = function () {
                    signatureModal.classList.add('hidden');
                };
            }
            const canvas = document.getElementById('signatureCanvas');
            const ctx = canvas ? canvas.getContext('2d') : null;
            let drawing = false;
            let lastX = 0, lastY = 0;
            if (canvas && ctx) {
                canvas.addEventListener('mousedown', function (e) {
                    drawing = true;
                    const rect = canvas.getBoundingClientRect();
                    lastX = e.clientX - rect.left;
                    lastY = e.clientY - rect.top;
                });
                canvas.addEventListener('mousemove', function (e) {
                    if (!drawing) return;
                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    ctx.beginPath();
                    ctx.moveTo(lastX, lastY);
                    ctx.lineTo(x, y);
                    ctx.strokeStyle = '#222';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    lastX = x;
                    lastY = y;
                });
                canvas.addEventListener('mouseup', function () { drawing = false; });
                canvas.addEventListener('mouseleave', function () { drawing = false; });
                canvas.addEventListener('touchstart', function (e) {
                    drawing = true;
                    const rect = canvas.getBoundingClientRect();
                    const touch = e.touches[0];
                    lastX = touch.clientX - rect.left;
                    lastY = touch.clientY - rect.top;
                });
                canvas.addEventListener('touchmove', function (e) {
                    if (!drawing) return;
                    const rect = canvas.getBoundingClientRect();
                    const touch = e.touches[0];
                    const x = touch.clientX - rect.left;
                    const y = touch.clientY - rect.top;
                    ctx.beginPath();
                    ctx.moveTo(lastX, lastY);
                    ctx.lineTo(x, y);
                    ctx.strokeStyle = '#222';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    lastX = x;
                    lastY = y;
                    e.preventDefault();
                }, { passive: false });
                canvas.addEventListener('touchend', function () { drawing = false; });
                canvas.addEventListener('touchcancel', function () { drawing = false; });

                // 檢查畫布是否為空的函數
                function isCanvasEmpty(canvas) {
                    const ctx = canvas.getContext('2d');
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;

                    for (let i = 0; i < data.length; i += 4) {
                        if (data[i + 3] !== 0) { // alpha 值不為 0 表示有內容
                            return false;
                        }
                    }
                    return true;
                }

                document.getElementById('clearSignatureBtn').onclick = function () {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                };
                document.getElementById('saveSignatureBtn').onclick = function () {
                    signatureDataURL = canvas.toDataURL('image/png');
                    previewDiv.innerHTML = `<img src='${signatureDataURL}' alt='簽名預覽' style='max-width:160px;max-height:60px;border:1px solid #ADB5BD;border-radius:8px;background:#fff;' />`;
                    signatureModal.classList.add('hidden');
                };
            }
        });
    </script>
</body>

</html>