<!DOCTYPE html>
<html lang="zh-TW">

<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>審核案件管理-編輯(縣府)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .fixed-bottom-bar {
            position: sticky;
            left: 0;
            bottom: 0;
            width: 100vw;
            z-index: 50;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.06);
            background: #fff;
        }

        .work-photo-preview {
            min-height: 200px;
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 8px;
        }

        .work-photo-preview img,
        .work-photo-preview video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }

        @media (max-width: 640px) {
            .form-section-grid {
                display: flex;
                flex-direction: column;
                gap: 1rem;
            }

            .bottom-btns {
                flex-direction: row !important;
                gap: 0.75rem !important;
                align-items: center !important;
            }

            .upload-section {
                flex-direction: column !important;
                gap: 1rem !important;
            }

            .upload-section>div {
                margin-bottom: 0.5rem;
            }

            .main-padding {
                padding: 1rem !important;
            }

            .page-title {
                font-size: 1.25rem !important;
            }

            /* 電子簽章區塊手機版維持並列 */
            .signature-row {
                display: grid !important;
                grid-template-columns: 1fr 1fr !important;
                gap: 1rem !important;
            }
        }

        .work-photo-preview {
            width: 100px;
            height: 100px;
            border-radius: 0.5rem;
            overflow: hidden;
            background: #f3f3f3;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 物種狀況橫向排列 */
        @media (min-width: 768px) {
            .species-status-row {
                display: flex;
                flex-direction: row;
                gap: 1rem;
                align-items: flex-start;
            }

            .species-status-row>* {
                min-width: 180px;
                flex: 1 1 0;
            }
        }

        /* 新增預覽區塊固定尺寸CSS */
        .work-photo-preview.relative {
            width: 100px;
            height: 100px;
            min-width: 100px;
            min-height: 100px;
            max-width: 100px;
            max-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .work-photo-preview.relative img,
        .work-photo-preview.relative video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css" crossorigin="anonymous">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#6C936D',
                        'secondary': '#3F5146',
                        'accent': '#417991',
                        'danger': '#DC3545',
                        'warning': '#EAD065',
                        'gray-light': '#F8F9FA',
                        'gray-medium': '#6C757D',
                        'gray-dark': '#495057',
                        'border': '#ADB5BD',
                        'green-light': '#C5E0C7',
                        'bg-light': '#F3F3F3'
                    },
                    fontFamily: {
                        'noto': ['Noto Sans TC', 'sans-serif']
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-bg-light font-noto">
    <!-- 引入 header.html -->
    <div id="header"></div>
    <script>
        fetch('header.html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('header').innerHTML = html;
                // 手動初始化 header 功能
                if (window.initializeHeader) {
                    window.initializeHeader();
                }
            });
    </script>
    <script src="header-utils.js"></script>
    <main class="p-2 md:p-4 max-w-[1440px] mx-auto">
        <!-- 頁面標題 -->
        <div class="bg-white shadow-lg rounded-lg border-l-4 border-primary p-2 mb-4">
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center px-2 md:px-4 py-2 gap-2">
                <h2 class="text-xl md:text-2xl font-bold text-secondary">審核案件管理-編輯</h2>
                <div class="flex items-center gap-1 text-gray-medium text-sm">
                    <span>首頁</span>
                    <span>/</span>
                    <span>審核案件管理</span>
                    <span>/</span>
                    <span class="text-primary font-bold">編輯</span>
                </div>
            </div>
        </div>

        <!-- 表單區塊 -->
        <form class="bg-white rounded-lg shadow-lg border border-gray-200 p-4 md:p-6 lg:p-8 space-y-8">
            <!-- 通報基本資料 -->
            <section>
                <div
                    class="flex items-center gap-2 mb-4 bg-gray-light border-l-2 border-primary px-4 py-2 justify-between">
                    <div class="flex items-center gap-2">
                        <!-- 通報基本資料 icon -->
                        <i class="fas fa-clipboard text-primary w-4 h-4 mr-1"></i>
                        <h3 class="text-lg md:text-xl font-bold text-primary">通報基本資料</h3>
                    </div>
                    <div class="flex items-center gap-2">
                        <button type="button" id="toggleBasicInfoBtn"
                            class="bg-primary text-white px-3 py-1 rounded text-sm font-medium hover:bg-green-700 transition">
                            <span id="toggleBasicInfoText">收合</span>
                            <i id="toggleBasicInfoIcon" class="fas fa-chevron-up ml-1"></i>
                        </button>

                    </div>
                </div>
                <div class="border border-border rounded p-4" id="basicInfoBlock">
                    <!-- 第一行 -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label class="block text-gray-dark font-medium mb-1">立案編號</label>
                            <span class="block text-gray-700 bg-gray-100 rounded px-2 py-1">T1130428001</span>
                        </div>
                        <div>
                            <label class="block text-gray-dark font-medium mb-1">通報來源</label>
                            <span class="block text-gray-700 bg-gray-100 rounded px-2 py-1">119</span>
                        </div>
                        <div>
                            <label class="block text-gray-dark font-medium mb-1">通報時間</label>
                            <span class="block text-gray-700 bg-gray-100 rounded px-2 py-1">2024/04/28 20:20:21</span>
                        </div>
                        <div>
                            <label class="block text-gray-dark font-medium mb-1">通報人</label>
                            <span class="block text-gray-700 bg-gray-100 rounded px-2 py-1">王小明</span>
                        </div>
                    </div>
                    <!-- 第二行 -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label class="block text-gray-dark font-medium mb-1">性別</label>
                            <span class="block text-gray-700 bg-gray-100 rounded px-2 py-1">先生</span>
                        </div>
                        <div>
                            <label class="block text-gray-dark font-medium mb-1">通報人電話</label>
                            <span class="block text-gray-700 bg-gray-100 rounded px-2 py-1">0912345678</span>
                        </div>
                        <div>
                            <label class="block text-gray-dark font-medium mb-1">電話值班人員</label>
                            <span class="block text-gray-700 bg-gray-100 rounded px-2 py-1">林值班</span>
                        </div>
                        <div>
                            <label class="block text-gray-dark font-medium mb-1">案件類型</label>
                            <span class="block text-gray-700 bg-gray-100 rounded px-2 py-1">捉蛇</span>
                        </div>
                    </div>
                    <!-- 第三行 -->
                    <div class="mb-4">
                        <label class="block text-gray-dark font-medium mb-1">通報地址</label>
                        <span class="block text-gray-700 bg-gray-100 rounded px-2 py-1">屏東縣不拘自由路527號</span>
                    </div>
                </div>
            </section>
            <!-- 內勤作業紀錄 -->
            <section>
                <div
                    class="flex items-center gap-2 mb-4 bg-gray-light border-l-2 border-primary px-4 py-2 justify-between">
                    <div class="flex items-center gap-2">
                        <!-- 內勤作業紀錄 icon -->
                        <i class="fas fa-clipboard text-primary w-4 h-4 mr-1"></i>
                        <h3 class="text-lg md:text-xl font-bold text-primary">內勤作業紀錄</h3>
                    </div>
                    <button type="button" id="toggleDutyRecordBtn"
                        class="bg-primary text-white px-3 py-1 rounded text-sm font-medium hover:bg-green-700 transition">
                        <span id="toggleDutyRecordText">收合</span>
                        <i id="toggleDutyRecordIcon" class="fas fa-chevron-up ml-1"></i>
                    </button>
                </div>
                <div class="border border-border rounded p-4" id="dutyRecordBlock">
                    <!-- 第一行 -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label class="block text-gray-dark font-medium mb-1">作業廠商</label>
                            <span class="block text-gray-700 bg-gray-100 rounded px-2 py-1">廠商A</span>
                        </div>
                        <div>
                            <label class="block text-gray-dark font-medium mb-1">指派人員</label>
                            <span class="block text-gray-700 bg-gray-100 rounded px-2 py-1">許ＯＯ</span>
                        </div>
                        <div>
                            <label class="block text-gray-dark font-medium mb-1">物種名稱</label>
                            <span class="block text-gray-700 bg-gray-100 rounded px-2 py-1">眼鏡蛇</span>
                        </div>
                        <div>
                            <label class="block text-gray-dark font-medium mb-1">廠商聯繫通報人時間</label>
                            <span class="block text-gray-700 bg-gray-100 rounded px-2 py-1">2025/07/13 10:00:00</span>
                        </div>
                    </div>
                    <!-- 第二行 -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label class="block text-gray-dark font-medium mb-1">通報人願意於現場等待</label>
                            <span class="block text-gray-700 bg-gray-100 rounded px-2 py-1">否</span>
                        </div>
                        <div>
                            <label class="block text-gray-dark font-medium mb-1">通報物仍在現場，尚未脫逃</label>
                            <span class="block text-gray-700 bg-gray-100 rounded px-2 py-1">否</span>
                        </div>
                        <div>
                            <label class="block text-gray-dark font-medium mb-1">是否有飼主</label>
                            <span class="block text-gray-700 bg-gray-100 rounded px-2 py-1">否</span>
                        </div>
                        <div>
                            <!-- 空白或保留未來欄位 -->
                        </div>
                    </div>
                </div>
            </section>
            <!-- 外勤作業紀錄 -->
            <section>
                <div class="flex items-center justify-between mb-4 bg-gray-light border-l-2 border-primary px-4 py-2">
                    <div class="flex items-center gap-2">
                        <!-- 外勤作業紀錄 icon -->
                        <i class="fas fa-image text-primary w-4 h-4 mr-1"></i>
                        <h3 class="text-lg md:text-xl font-bold text-primary">外勤作業紀錄</h3>
                    </div>
                    <span class="text-sm text-gray-dark">回報日期： yyy/mm/dd</span>
                </div>
                <div class="border border-border rounded p-4" id="fieldWorkBlock">
                    <!-- 第一行：值勤人員抵達時間和座標 -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <div class="min-w-0 md:col-span-2 flex flex-col">
                            <label class="block text-gray-dark font-medium mb-1">值勤人員抵達時間</label>
                            <span class="block text-gray-700 bg-gray-100 rounded px-2 py-1">2025/07/13 10:30:00</span>
                        </div>
                        <div class="min-w-0 md:col-span-2">
                            <label class="block text-gray-dark font-medium mb-1">座標</label>
                            <span
                                class="block text-gray-700 bg-gray-100 rounded px-2 py-1">23.1291823,120.2520685</span>
                        </div>
                    </div>
                    <!-- 第二行：四個radio欄位 -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label class="block text-gray-dark font-medium mb-1">通報人仍在現場</label>
                            <span class="block text-gray-700 bg-gray-100 rounded px-2 py-1">否</span>
                        </div>
                        <div>
                            <label class="block text-gray-dark font-medium mb-1">通報物仍在現場，尚未脫逃</label>
                            <span class="block text-gray-700 bg-gray-100 rounded px-2 py-1">否</span>
                        </div>
                        <div>
                            <label class="block text-gray-dark font-medium mb-1">是否為通報案件類型</label>
                            <span class="block text-gray-700 bg-gray-100 rounded px-2 py-1">否</span>
                        </div>
                        <div>
                            <label class="block text-gray-dark font-medium mb-1">是否有飼主</label>
                            <span class="block text-gray-700 bg-gray-100 rounded px-2 py-1">否</span>
                        </div>
                    </div>
                    <!-- 第三行：物種相關欄位 -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label class="block text-gray-dark font-medium mb-1">物種名稱</label>
                            <span class="block text-gray-700 bg-gray-100 rounded px-2 py-1">蛇類</span>
                        </div>
                        <div>
                            <label class="block text-gray-dark font-medium mb-1">數量</label>
                            <span class="block text-gray-700 bg-gray-100 rounded px-2 py-1">1</span>
                        </div>
                        <div>
                            <label class="block text-gray-dark font-medium mb-1">物種狀況</label>
                            <span class="block text-gray-700 bg-gray-100 rounded px-2 py-1">健康</span>
                        </div>
                        <div>
                            <label class="block text-gray-dark font-medium mb-1">處理情形</label>
                            <span class="block text-gray-700 bg-gray-100 rounded px-2 py-1">後送</span>
                        </div>
                    </div>
                    <!-- 第四行：通報人是否願意支付費用 -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label class="block text-gray-dark font-medium mb-1">通報人是否願意支付費用</label>
                            <span class="block text-gray-700 bg-gray-100 rounded px-2 py-1">否</span>
                        </div>
                        <div></div>
                        <div></div>
                        <div></div>
                    </div>
                    <!-- 外勤作業照片上傳區 -->
                    <div class="mt-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- 處理前紀錄 -->
                            <div id="workPhotoBlock1"
                                class="work-photo-block w-full p-4 rounded-lg border border-gray-200">
                                <div class="work-photo-title flex items-center text-gray-dark font-medium mb-3">
                                    <span>處理前紀錄</span>
                                    <span class="text-xs text-gray-500 ml-2">(<span id="photoCount1">2</span>/4)</span>
                                </div>
                                <div id="workPhotoPreview1"
                                    class="work-photo-preview grid grid-cols-4 gap-2 w-full min-h-[80px]">
                                    <!-- 照片位置1 -->
                                    <div class="photo-slot relative aspect-square w-full" style="display:block;">
                                        <img class="w-full h-full object-cover rounded cursor-pointer" alt="照片1"
                                            src="img/Review01.jpg">
                                    </div>
                                    <!-- 照片位置2 -->
                                    <div class="photo-slot relative aspect-square w-full" style="display:block;">
                                        <img class="w-full h-full object-cover rounded cursor-pointer" alt="照片2"
                                            src="img/Review02.jpg">
                                    </div>
                                    <!-- 照片位置3 -->
                                    <div class="photo-slot relative aspect-square w-full" style="display:none;">
                                        <img class="w-full h-full object-cover rounded cursor-pointer" alt="照片3">
                                    </div>
                                    <!-- 照片位置4 -->
                                    <div class="photo-slot relative aspect-square w-full" style="display:none;">
                                        <img class="w-full h-full object-cover rounded cursor-pointer" alt="照片4">
                                    </div>
                                </div>
                            </div>

                            <!-- 處理完成紀錄 -->
                            <div id="workPhotoBlock3"
                                class="work-photo-block w-full p-4 rounded-lg border border-gray-200">
                                <div class="work-photo-title flex items-center text-gray-dark font-medium mb-3">
                                    <span>處理完成紀錄</span>
                                    <span class="text-xs text-gray-500 ml-2">(<span id="photoCount3">1</span>/4)</span>
                                </div>
                                <div id="workPhotoPreview3"
                                    class="work-photo-preview grid grid-cols-4 gap-2 w-full min-h-[80px]">
                                    <!-- 照片位置1 -->
                                    <div class="photo-slot relative aspect-square w-full" style="display:block;">
                                        <img class="w-full h-full object-cover rounded cursor-pointer" alt="照片1"
                                            src="img/Review03.jpg">
                                    </div>
                                    <!-- 照片位置2 -->
                                    <div class="photo-slot relative aspect-square w-full" style="display:none;">
                                        <img class="w-full h-full object-cover rounded cursor-pointer" alt="照片2">
                                    </div>
                                    <!-- 照片位置3 -->
                                    <div class="photo-slot relative aspect-square w-full" style="display:none;">
                                        <img class="w-full h-full object-cover rounded cursor-pointer" alt="照片3">
                                    </div>
                                    <!-- 照片位置4 -->
                                    <div class="photo-slot relative aspect-square w-full" style="display:none;">
                                        <img class="w-full h-full object-cover rounded cursor-pointer" alt="照片4">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <!-- 新增：後送作業紀錄 -->
            <section>
                <div class="flex items-center gap-2 mb-4 bg-gray-light border-l-2 border-primary px-4 py-2">
                    <!-- 後送作業紀錄 icon -->
                    <i class="fas fa-truck text-primary w-4 h-4 mr-1"></i>
                    <h3 class="text-lg md:text-xl font-bold text-primary">後送作業紀錄</h3>
                </div>
                <div class="border border-border rounded p-4" id="transferRecordBlock">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-gray-dark font-medium mb-1">
                                <span class="text-danger">*</span> 後送單位
                            </label>
                            <span class="block text-gray-700 bg-gray-100 rounded px-2 py-1">動物之家</span>
                        </div>
                        <div>
                            <label class="block text-gray-dark font-medium mb-1">
                                <span class="text-danger">*</span> 後送日期
                            </label>
                            <span class="block text-gray-700 bg-gray-100 rounded px-2 py-1">2024/04/28 20:20:21</span>
                        </div>
                    </div>
                </div>
            </section>
            <!-- 電子簽章 -->
            <section>
                <div class="flex items-center gap-2 mb-4 bg-gray-light border-l-2 border-primary px-4 py-2">
                    <!-- 電子簽章 icon -->
                    <i class="fas fa-clipboard text-primary w-4 h-4 mr-1"></i>
                    <h3 class="text-lg md:text-xl font-bold text-primary">電子簽章</h3>
                </div>
                <div class="border border-border rounded p-4" id="signatureBlock">
                    <div class="signature-row grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-dark font-medium mb-1">通報人</label>
                            <a href="#"
                                class="block text-gray-700 bg-gray-100 rounded px-2 py-1 underline hover:text-primary"
                                id="signaturePreviewLink">王小明（已簽名）</a>
                        </div>
                        <div>
                            <label class="block text-gray-dark font-medium mb-1">簽章日期</label>
                            <input type="date"
                                class="block w-full bg-gray-100 border border-gray-300 rounded px-2 py-1 text-gray-700"
                                value="2024-04-28" readonly />
                        </div>
                    </div>
                </div>
            </section>
            <!-- 審核紀錄 -->
            <section>
                <div class="flex items-center gap-2 mb-4 bg-gray-light border-l-2 border-primary px-4 py-2">
                    <!-- 審核紀錄 icon -->
                    <i class="fas fa-clipboard text-primary w-4 h-4 mr-1"></i>
                    <h3 class="text-lg md:text-xl font-bold text-primary">審核紀錄</h3>
                </div>
                <div class="border border-border rounded p-4" id="reviewRecordBlock">
                    <!-- 審核記錄表格 -->
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-300">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="border border-gray-300 px-3 py-2 text-left text-gray-dark font-medium">
                                        審核人員</th>
                                    <th class="border border-gray-300 px-3 py-2 text-left text-gray-dark font-medium">
                                        審核日期</th>
                                    <th class="border border-gray-300 px-3 py-2 text-left text-gray-dark font-medium">
                                        審核結果</th>
                                    <th class="border border-gray-300 px-3 py-2 text-left text-gray-dark font-medium">
                                        退回/不通過類別</th>
                                    <th class="border border-gray-300 px-3 py-2 text-left text-gray-dark font-medium">
                                        退回/不通過原因</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="border border-gray-300 px-3 py-2">李審核員</td>
                                    <td class="border border-gray-300 px-3 py-2">2025/07/31 14:30:00</td>
                                    <td class="border border-gray-300 px-3 py-2">通過</td>
                                    <td class="border border-gray-300 px-3 py-2">-</td>
                                    <td class="border border-gray-300 px-3 py-2">-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <!-- 警告區塊（紅色） -->
                    <div class="flex items-center bg-red-100 border-l-4 border-red-500 p-3 rounded mb-2 mt-4">
                        <img src="img/warning.png" alt="警告" class="w-5 h-5 mr-2"
                            style="filter: grayscale(0) brightness(1) sepia(1) hue-rotate(-20deg) saturate(8) opacity(0.9);">
                        <span class="text-red-800 font-semibold">資料庫中有相同照片，請確認是否重複上傳！</span>
                    </div>
                </div>
            </section>
            <!-- 點交紀錄 -->
            <section>
                <div class="flex items-center gap-2 mb-4 bg-gray-light border-l-2 border-primary px-4 py-2">
                    <!-- 點交紀錄 icon -->
                    <i class="fas fa-exchange-alt text-primary w-4 h-4 mr-1"></i>
                    <h3 class="text-lg md:text-xl font-bold text-primary">點交紀錄</h3>
                </div>
                <div class="border border-border rounded p-4" id="handoverRecordBlock">
                    <!-- 點交紀錄表格 -->
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-300">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="border border-gray-300 px-3 py-2 text-left text-gray-dark font-medium">
                                        點交人員</th>
                                    <th class="border border-gray-300 px-3 py-2 text-left text-gray-dark font-medium">
                                        點交日期</th>
                                    <th class="border border-gray-300 px-3 py-2 text-left text-gray-dark font-medium">
                                        點交結果</th>
                                    <th class="border border-gray-300 px-3 py-2 text-left text-gray-dark font-medium">
                                        點交物現況</th>
                                    <th class="border border-gray-300 px-3 py-2 text-left text-gray-dark font-medium">
                                        限期交回日期</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="border border-gray-300 px-3 py-2">張點交員</td>
                                    <td class="border border-gray-300 px-3 py-2">2025/07/30 16:00:00</td>
                                    <td class="border border-gray-300 px-3 py-2">
                                        <select id="handoverResult"
                                            class="w-full bg-white border border-gray-300 rounded px-2 py-1 text-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                                            <option value="">請選擇</option>
                                            <option value="限期交回" selected>限期交回</option>
                                            <option value="不計價">不計價</option>
                                            <option value="點交完成">點交完成</option>
                                        </select>
                                    </td>
                                    <td class="border border-gray-300 px-3 py-2">
                                        <select id="handoverStatus"
                                            class="w-full bg-white border border-gray-300 rounded px-2 py-1 text-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                                            <option value="">請選擇</option>
                                            <option value="健康">健康</option>
                                            <option value="受傷">受傷</option>
                                            <option value="已死亡" selected>已死亡</option>
                                        </select>
                                    </td>
                                    <td class="border border-gray-300 px-3 py-2">
                                        <input type="date" id="returnDeadlineDate"
                                            class="w-full bg-white border border-gray-300 rounded px-2 py-1 text-gray-700 focus:outline-none focus:ring-2 focus:ring-primary"
                                            value="2025-08-15">
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </form>
    </main>

    <!-- 底部按鈕 -->
    <div class="fixed-bottom-bar bg-white shadow-lg border-t border-gray-200 py-2">
        <div class="bottom-btns flex flex-wrap justify-center items-center gap-2 max-w-[1440px] mx-auto px-4">
            <button type="button"
                class="min-w-[96px] bg-white text-gray-medium border border-gray-medium px-4 py-2 rounded hover:bg-gray-100 transition">取消</button>
            <button type="button"
                class="min-w-[96px] bg-gray-medium text-white px-4 py-2 rounded hover:bg-gray-dark transition flex items-center gap-1">
                <i class="fas fa-save w-3.5 h-3.5 mr-1"></i>
                暫存
            </button>
            <button type="button" id="reviewRejectBtn"
                class="min-w-[96px] bg-danger text-white px-4 py-2 rounded hover:bg-red-700 transition flex items-center gap-1">
                <i class="fas fa-times w-3.5 h-3.5 mr-1"></i>
                退回
            </button>
            <button type="button" id="reviewPassBtn"
                class="min-w-[96px] bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition flex items-center gap-1">
                <i class="fas fa-check-circle w-3.5 h-3.5 mr-1"></i>
                審核完成
            </button>
        </div>
    </div>

    <script>
        // 全部互動功能
        document.addEventListener('DOMContentLoaded', function () {
            // 檢測檔案類型的輔助函數（全域函數）
            window.isVideoFile = function (dataUrl) {
                return dataUrl && dataUrl.startsWith('data:video/');
            };

            // 通過按鈕功能（審核記錄已為唯讀，不需驗證）
            var reviewPassBtn = document.getElementById('reviewPassBtn');
            if (reviewPassBtn) {
                reviewPassBtn.addEventListener('click', function (e) {
                    // 驗證通過，跳出確認視窗
                    e.preventDefault();
                    showReviewPassConfirmModal();
                });

                // 審核通過確認視窗
                function showReviewPassConfirmModal() {
                    let modal = document.getElementById('reviewPassConfirmModal');
                    if (!modal) {
                        modal = document.createElement('div');
                        modal.id = 'reviewPassConfirmModal';
                        modal.style.position = 'fixed';
                        modal.style.top = '0';
                        modal.style.left = '0';
                        modal.style.width = '100vw';
                        modal.style.height = '100vh';
                        modal.style.background = 'rgba(0,0,0,0.5)';
                        modal.style.display = 'flex';
                        modal.style.justifyContent = 'center';
                        modal.style.alignItems = 'center';
                        modal.style.zIndex = '9999';
                        modal.innerHTML = `
                            <div style='background:#fff;padding:32px 40px;border-radius:12px;box-shadow:0 2px 16px #0008;text-align:center;min-width:320px;'>
                                <h2 style='font-size:1.25rem;font-weight:bold;margin-bottom:16px;'>確定要通過審核嗎？</h2>
                                <div style='margin-bottom:24px;'>審核紀錄填寫完成，請確認是否通過。</div>
                                <button id='confirmReviewPassBtn' style='background:#198754;color:#fff;padding:8px 24px;border:none;border-radius:6px;font-size:1rem;font-weight:bold;cursor:pointer;margin-right:16px;'>確定</button>
                                <button id='cancelReviewPassBtn' style='background:#6c757d;color:#fff;padding:8px 24px;border:none;border-radius:6px;font-size:1rem;font-weight:bold;cursor:pointer;'>取消</button>
                            </div>
                        `;
                        document.body.appendChild(modal);
                        document.getElementById('confirmReviewPassBtn').onclick = function () {
                            modal.style.display = 'none';
                            // 通過後跳轉 ReviewCaseManagement_List.html
                            window.location.href = 'ReviewCaseManagement_List.html';
                        };
                        document.getElementById('cancelReviewPassBtn').onclick = function () {
                            modal.style.display = 'none';
                        };
                    } else {
                        modal.style.display = 'flex';
                    }
                }
            }

            // 退回按鈕功能
            var reviewRejectBtn = document.getElementById('reviewRejectBtn');
            if (reviewRejectBtn) {
                reviewRejectBtn.addEventListener('click', function (e) {
                    e.preventDefault();
                    showReviewRejectModal();
                });

                // 審核退回視窗
                function showReviewRejectModal() {
                    let modal = document.getElementById('reviewRejectModal');
                    if (!modal) {
                        modal = document.createElement('div');
                        modal.id = 'reviewRejectModal';
                        modal.style.position = 'fixed';
                        modal.style.top = '0';
                        modal.style.left = '0';
                        modal.style.width = '100vw';
                        modal.style.height = '100vh';
                        modal.style.background = 'rgba(0,0,0,0.5)';
                        modal.style.display = 'flex';
                        modal.style.justifyContent = 'center';
                        modal.style.alignItems = 'center';
                        modal.style.zIndex = '9999';
                        modal.innerHTML = `
                            <div style='background:#fff;padding:32px;border-radius:12px;box-shadow:0 2px 16px #0008;min-width:400px;max-width:500px;'>
                                <h2 style='font-size:1.25rem;font-weight:bold;margin-bottom:20px;text-align:center;color:#dc3545;'>審核退回</h2>
                                <div style='margin-bottom:16px;'>
                                    <label style='display:block;font-weight:bold;margin-bottom:8px;color:#333;'>
                                        <span style='color:#dc3545;margin-right:4px;'>*</span>退回原因類別
                                    </label>
                                    <select id='rejectCategorySelect' style='width:100%;padding:8px 12px;border:1px solid #ccc;border-radius:6px;font-size:14px;'>
                                        <option value=''>請選擇</option>
                                        <option value='照片問題'>照片問題</option>
                                        <option value='資料填寫不完整'>資料填寫不完整</option>
                                        <option value='處理程序錯誤'>處理程序錯誤</option>
                                        <option value='其他'>其他</option>
                                    </select>
                                </div>
                                <div style='margin-bottom:24px;'>
                                    <label style='display:block;font-weight:bold;margin-bottom:8px;color:#333;'>
                                        <span style='color:#dc3545;margin-right:4px;'>*</span>退回說明
                                    </label>
                                    <textarea id='rejectReasonTextarea' placeholder='請詳細說明退回原因...' 
                                        style='width:100%;height:100px;padding:8px 12px;border:1px solid #ccc;border-radius:6px;font-size:14px;resize:vertical;'></textarea>
                                </div>
                                <div style='text-align:center;'>
                                    <button id='confirmRejectBtn' style='background:#dc3545;color:#fff;padding:10px 24px;border:none;border-radius:6px;font-size:1rem;font-weight:bold;cursor:pointer;margin-right:16px;'>確定退回</button>
                                    <button id='cancelRejectBtn' style='background:#6c757d;color:#fff;padding:10px 24px;border:none;border-radius:6px;font-size:1rem;font-weight:bold;cursor:pointer;'>取消</button>
                                </div>
                            </div>
                        `;
                        document.body.appendChild(modal);

                        document.getElementById('confirmRejectBtn').onclick = function () {
                            const category = document.getElementById('rejectCategorySelect').value;
                            const reason = document.getElementById('rejectReasonTextarea').value.trim();

                            if (!category) {
                                alert('請選擇退回原因類別');
                                return;
                            }
                            if (!reason) {
                                alert('請填寫退回說明');
                                return;
                            }

                            // 這裡可以加入提交退回資料的邏輯
                            modal.style.display = 'none';
                            alert('案件已退回');
                            window.location.href = 'ReviewCaseManagement_List.html';
                        };

                        document.getElementById('cancelRejectBtn').onclick = function () {
                            modal.style.display = 'none';
                        };
                    } else {
                        modal.style.display = 'flex';
                        // 清空之前的輸入
                        document.getElementById('rejectCategorySelect').value = '';
                        document.getElementById('rejectReasonTextarea').value = '';
                    }
                }
            }
            // 電子簽章預覽功能
            var signaturePreviewLink = document.getElementById('signaturePreviewLink');
            if (signaturePreviewLink) {
                signaturePreviewLink.addEventListener('click', function (e) {
                    e.preventDefault();
                    let modal = document.getElementById('signaturePreviewModal');
                    if (!modal) {
                        modal = document.createElement('div');
                        modal.id = 'signaturePreviewModal';
                        modal.style.position = 'fixed';
                        modal.style.top = '0';
                        modal.style.left = '0';
                        modal.style.width = '100vw';
                        modal.style.height = '100vh';
                        modal.style.background = 'rgba(0,0,0,0.7)';
                        modal.style.display = 'flex';
                        modal.style.justifyContent = 'center';
                        modal.style.alignItems = 'center';
                        modal.style.zIndex = '9999';
                        modal.innerHTML = `
                            <img src='img/Signature_img.png' alt='簽名預覽' style='max-width:90vw;max-height:90vh;border-radius:12px;box-shadow:0 2px 16px #0008;' />
                            <button id='closeSignaturePreviewModalBtn' style='position:absolute;top:32px;right:32px;background:#fff;border:none;border-radius:50%;width:40px;height:40px;box-shadow:0 2px 8px #0004;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1.5rem;'>×</button>
                        `;
                        document.body.appendChild(modal);
                        document.getElementById('closeSignaturePreviewModalBtn').onclick = function (ev) {
                            modal.style.display = 'none';
                            ev.stopPropagation();
                        };
                        modal.onclick = function (ev) {
                            if (ev.target === modal) {
                                modal.style.display = 'none';
                            }
                        };
                    } else {
                        modal.style.display = 'flex';
                    }
                });
            }
            // 照片移除功能（只保留修正版）
            function setupRemovePhotoBtn(idx) {
                const inputId = `workPhotoInput${idx}`;
                const previewId = `workPhotoPreview${idx}`;
                const removeBtnId = `removePhotoBtn${idx}`;
                const input = document.getElementById(inputId);
                const preview = document.getElementById(previewId);
                const removeBtn = document.getElementById(removeBtnId);
                if (!input || !preview || !removeBtn) return;
                input.addEventListener('change', function () {
                    // 清空預覽區塊（只保留 removeBtn）
                    while (preview.firstChild) preview.removeChild(preview.firstChild);
                    // 先 append removeBtn（絕對定位）
                    preview.appendChild(removeBtn);
                    // 處理圖片
                    if (input.files && input.files.length > 0) {
                        const file = input.files[0];
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            // 移除舊 img
                            const oldImg = preview.querySelector('img');
                            if (oldImg) oldImg.remove();
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.style.maxWidth = '100%';
                            img.style.maxHeight = '120px';
                            img.style.display = 'block';
                            img.style.margin = '0 auto';
                            // 插入在 removeBtn 之後
                            preview.appendChild(img);
                            removeBtn.style.display = '';
                            // 處理提示文字
                            let tip = preview.querySelector('.work-photo-tip');
                            if (!tip) {
                                tip = document.createElement('span');
                                tip.className = 'work-photo-tip';
                                tip.style.color = '#6c757d';
                                tip.textContent = '點擊上方按鈕選擇檔案';
                                tip.style.display = 'block';
                                tip.style.textAlign = 'center';
                                tip.style.marginTop = '4px';
                                preview.appendChild(tip);
                            }
                        };
                        reader.readAsDataURL(file);
                    } else {
                        removeBtn.style.display = 'none';
                        // 處理提示文字
                        let tip = preview.querySelector('.work-photo-tip');
                        if (!tip) {
                            tip = document.createElement('span');
                            tip.className = 'work-photo-tip';
                            tip.style.color = '#6c757d';
                            tip.textContent = '點擊上方按鈕選擇檔案';
                            tip.style.display = 'block';
                            tip.style.textAlign = 'center';
                            tip.style.marginTop = '4px';
                            preview.appendChild(tip);
                        }
                    }
                });
                removeBtn.addEventListener('click', function () {
                    input.value = '';
                    // 清空預覽區塊（只保留 removeBtn）
                    while (preview.firstChild) preview.removeChild(preview.firstChild);
                    preview.appendChild(removeBtn);
                    removeBtn.style.display = 'none';
                    // 處理提示文字
                    let tip = preview.querySelector('.work-photo-tip');
                    if (!tip) {
                        tip = document.createElement('span');
                        tip.className = 'work-photo-tip';
                        tip.style.color = '#6c757d';
                        tip.textContent = '點擊上方按鈕選擇檔案';
                        tip.style.display = 'block';
                        tip.style.textAlign = 'center';
                        tip.style.marginTop = '4px';
                        preview.appendChild(tip);
                    }
                    // 觸發 input 的 change 事件，確保狀態同步
                    input.dispatchEvent(new Event('change'));
                });
                // 頁面載入時初始化預設提示
                while (preview.firstChild) preview.removeChild(preview.firstChild);
                preview.appendChild(removeBtn);
                removeBtn.style.display = 'none';
                let tip = preview.querySelector('.work-photo-tip');
                if (!tip) {
                    tip = document.createElement('span');
                    tip.className = 'work-photo-tip';
                    tip.style.color = '#6c757d';
                    tip.textContent = '點擊上方按鈕選擇檔案';
                    tip.style.display = 'block';
                    tip.style.textAlign = 'center';
                    tip.style.marginTop = '4px';
                    preview.appendChild(tip);
                }
            }
            setupRemovePhotoBtn(1);
            setupRemovePhotoBtn(2);
            setupRemovePhotoBtn(3);
            // 作業廠商與作業人員連動
            // 取得正確的作業廠商與作業人員 select
            const selects = document.querySelectorAll('#dutyRecordBlock select');
            // 0: 案件類型, 1: 作業廠商, 2: 作業人員
            const vendorSelect2 = selects[1];
            const staffSelect2 = selects[2];
            // 假設廠商A、B各自有不同人員
            const vendorStaffMap = {
                '廠商A': ['許ＯＯ', '陳ＯＯ'],
                '廠商B': ['李ＯＯ', '陳ＯＯ', '周ＯＯ'],
                '請選擇': []
            };
            function updateStaffOptions() {
                if (!vendorSelect2 || !staffSelect2) return;
                const vendor = vendorSelect2.value;
                let staffList = vendorStaffMap[vendor] || [];
                // 第一個選項永遠是「請選擇」
                let options = [`<option selected>請選擇</option>`];
                staffList.forEach(s => {
                    options.push(`<option>${s}</option>`);
                });
                staffSelect2.innerHTML = options.join('');
            }
            if (vendorSelect2) {
                vendorSelect2.addEventListener('change', function () {
                    updateStaffOptions();
                });
                // 頁面載入時也執行一次
                updateStaffOptions();
            }
            // 指派案件驗證作業廠商與作業人員
            const assignCaseBtn = document.getElementById('assignCaseBtn');
            if (assignCaseBtn) {
                assignCaseBtn.addEventListener('click', function (e) {
                    let vendorValue = '';
                    let staffValue = '';
                    if (vendorSelect2) vendorValue = vendorSelect2.value;
                    if (staffSelect2) staffValue = staffSelect2.value;
                    if (!vendorValue || vendorValue === '請選擇') {
                        alert('請選擇作業廠商');
                        return;
                    }
                    if (!staffValue || staffValue === '請選擇') {
                        alert('請選擇作業人員');
                        return;
                    }
                    // 自動填入現在時間到廠商聯繫通報人時間欄位
                    const vendorContactTimeInput = document.querySelector('#dutyRecordBlock input[type="text"]');
                    if (vendorContactTimeInput) {
                        const now = new Date();
                        const yyyy = now.getFullYear();
                        const mm = String(now.getMonth() + 1).padStart(2, '0');
                        const dd = String(now.getDate()).padStart(2, '0');
                        const hh = String(now.getHours()).padStart(2, '0');
                        const min = String(now.getMinutes()).padStart(2, '0');
                        const ss = String(now.getSeconds()).padStart(2, '0');
                        vendorContactTimeInput.value = `${yyyy}/${mm}/${dd} ${hh}:${min}:${ss}`;
                    }
                    // 通過驗證才可執行後續動作
                    // 顯示外勤作業紀錄區塊
                    const fieldWorkBlock = document.getElementById('fieldWorkBlock');
                    if (fieldWorkBlock) fieldWorkBlock.style.display = '';
                    // 顯示電子簽章區塊
                    const signatureBlock = document.getElementById('signatureBlock');
                    if (signatureBlock) signatureBlock.style.display = '';
                    // 將指派案件按鈕變成回報完成
                    const assignBtn = document.getElementById('assignCaseBtn');
                    if (assignBtn) {
                        assignBtn.innerHTML = '<i class="fas fa-check-circle w-3.5 h-3.5 mr-1"></i>回報完成';
                        assignBtn.type = 'submit';
                    }
                });
            }
            // 回報完成驗證外勤作業紀錄
            const assignBtn = document.getElementById('assignCaseBtn');
            if (assignBtn) {
                assignBtn.addEventListener('click', function (e) {
                    if (assignBtn.type === 'submit' && assignBtn.innerText.includes('回報完成')) {
                        // 驗證外勤作業紀錄必填欄位
                        const arriveTime = document.getElementById('arriveTimeField')?.value.trim();
                        const species = document.getElementById('speciesSelect')?.value;
                        const quantity = document.querySelector('#fieldWorkBlock input[type="text"]')?.value.trim();
                        const speciesStatus = document.getElementById('speciesStatusSelect')?.value;
                        const owner = Array.from(document.getElementsByName('hasOwner')).find(r => r.checked)?.nextElementSibling?.textContent;
                        const process = document.getElementById('processSelect')?.value;

                        let msg = '';
                        if (!arriveTime) msg += '請填寫值勤人員抵達時間\n';
                        if (!species || species === '不拘') msg += '請選擇物種\n';
                        if (!quantity) msg += '請填寫數量\n';
                        if (!speciesStatus) msg += '請選擇物種狀況\n';
                        if (!owner) msg += '請選擇是否有飼主\n';
                        if (!process) msg += '請選擇處理情形\n';
                        // 審核頁面不需要驗證照片上傳

                        if (msg) {
                            alert(msg);
                            e.preventDefault();
                            return;
                        }
                        // 驗證通過，跳出完成案件視窗
                        e.preventDefault();
                        showCompleteCaseModal();
                    }
                }, true);
            }
            // 完成案件視窗
            function showCompleteCaseModal() {
                let modal = document.getElementById('completeCaseModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'completeCaseModal';
                    modal.style.position = 'fixed';
                    modal.style.top = '0';
                    modal.style.left = '0';
                    modal.style.width = '100vw';
                    modal.style.height = '100vh';
                    modal.style.background = 'rgba(0,0,0,0.5)';
                    modal.style.display = 'flex';
                    modal.style.justifyContent = 'center';
                    modal.style.alignItems = 'center';
                    modal.style.zIndex = '9999';
                    modal.innerHTML = `
                        <div style='background:#fff;padding:32px 40px;border-radius:12px;box-shadow:0 2px 16px #0008;text-align:center;min-width:320px;'>
                            <h2 style='font-size:1.5rem;font-weight:bold;margin-bottom:16px;'>案件已完成</h2>
                            <p style='margin-bottom:24px;'>所有外勤作業紀錄已填寫，案件完成！</p>
                            <button id='closeCompleteCaseModalBtn' style='background:#198754;color:#fff;padding:8px 24px;border:none;border-radius:6px;font-size:1rem;font-weight:bold;cursor:pointer;'>確定</button>
                        </div>
                    `;
                    document.body.appendChild(modal);
                    document.getElementById('closeCompleteCaseModalBtn').onclick = function () {
                        window.location.href = 'DutyCaseManagement_List.html';
                    };
                } else {
                    modal.style.display = 'flex';
                }
            }
            // 屏東市/鄉鎮下拉選單控制
            const citySelect = document.querySelector('select.border-r');
            const townSelect = document.querySelector('select.rounded-r');
            if (citySelect && townSelect) {
                function updateTownVisibility() {
                    if (citySelect.value === '屏東市') {
                        townSelect.style.display = 'none';
                    } else {
                        townSelect.style.display = '';
                    }
                }
                citySelect.addEventListener('change', updateTownVisibility);
                updateTownVisibility();
            }

            // 案件類型與物種聯動
            const caseTypeSelect = document.getElementById('caseTypeSelect');
            const speciesSelect = document.getElementById('speciesSelect');
            const allSpeciesOptions = [
                '不拘', '蜜蜂', '虎頭蜂', '蛇類', '犬', '貓', '經濟動物', '野生動物', '游離蜂', '泥壺蜂', '綠鬣蜥'
            ];
            const beeSpeciesOptions = [
                '蜜蜂', '虎頭蜂', '游離蜂', '泥壺蜂'
            ];
            const iguanaSpeciesOptions = [
                '綠鬣蜥'
            ];
            function updateSpeciesOptionsByCaseType() {
                if (!caseTypeSelect || !speciesSelect) return;
                let options = allSpeciesOptions;
                if (caseTypeSelect.value === '蜂巢') {
                    options = beeSpeciesOptions;
                } else if (caseTypeSelect.value === '捉綠鬣蜥') {
                    options = iguanaSpeciesOptions;
                }
                speciesSelect.innerHTML = options.map(o => `<option>${o}</option>`).join('');
                speciesSelect.value = options[0];
                updateProcessOptions();
                updateWorkPhotoTips();
            }
            if (caseTypeSelect) {
                caseTypeSelect.addEventListener('change', updateSpeciesOptionsByCaseType);
                updateSpeciesOptionsByCaseType();
            }
            if (speciesSelect) {
                speciesSelect.addEventListener('change', function () {
                    updateProcessOptions();
                    updateWorkPhotoTips();
                });
            }

            // 處理情形動態調整
            function updateProcessOptions() {
                const speciesSelect = document.getElementById('speciesSelect');
                const statusSelect_main = document.getElementById('speciesStatusSelect');
                const ownerRadios = document.getElementsByName('hasOwner');
                const processSelect = document.getElementById('processSelect');
                const processLabel_main = document.getElementById('processLabel');
                const processStar_main = processLabel_main ? processLabel_main.querySelector('.text-danger') : null;
                const workPhotoBlock3 = document.getElementById('workPhotoBlock3');
                const workPhotoBlock2Star = document.querySelector('#workPhotoBlock2 .work-photo-title .text-danger');
                if (workPhotoBlock2Star) workPhotoBlock2Star.style.display = 'none';
                if (!speciesSelect || !statusSelect_main || !processSelect) return;
                const species = speciesSelect.value;
                const status = statusSelect_main.value;
                let owner = '否';
                if (ownerRadios && ownerRadios.length) {
                    owner = Array.from(ownerRadios).find(r => r.checked)?.nextElementSibling?.textContent || '否';
                }
                let options = [];
                let required = true;
                if (species === '野生動物' && status === '受傷') {
                    options = ['已逃跑', '後送'];
                } else if ((species === '犬' || species === '貓' || species === '經濟動物') && status === '受傷' && owner === '否') {
                    options = ['後送'];
                } else if ((species === '犬' || species === '貓' || species === '經濟動物') && status === '受傷' && owner === '是') {
                    options = ['後送'];
                    required = false;
                } else {
                    options = ['已逃跑', '現場放走', '野放', '後送'];
                }
                processSelect.innerHTML = options.map((o, i) => `<option${i === 0 ? ' selected' : ''}>${o}</option>`).join('');
                if (processStar_main) processStar_main.style.display = required ? '' : 'none';
                // 三個區塊都要顯示
                if (workPhotoBlock3) workPhotoBlock3.style.display = '';
            }
            // 綁定事件時直接取得元素，避免重複宣告
            if (document.getElementById('speciesSelect')) document.getElementById('speciesSelect').addEventListener('change', updateProcessOptions);
            if (document.getElementById('speciesStatusSelect')) document.getElementById('speciesStatusSelect').addEventListener('change', updateProcessOptions);
            const ownerRadiosInit = document.getElementsByName('hasOwner');
            if (ownerRadiosInit && ownerRadiosInit.length) {
                Array.from(ownerRadiosInit).forEach(r => r.addEventListener('change', updateProcessOptions));
            }
            if (document.getElementById('processSelect')) document.getElementById('processSelect').addEventListener('change', function () {
                const workPhotoBlock3 = document.getElementById('workPhotoBlock3');
                if (workPhotoBlock3) workPhotoBlock3.style.display = '';
            });
            updateProcessOptions();

            // 物種狀況管理
            const statusSelect_cascade = document.getElementById('speciesStatusSelect');
            const subBlock = document.getElementById('speciesStatusSubBlock');
            const subSelect = document.getElementById('speciesStatusSubSelect');
            const otherInput = document.getElementById('speciesStatusOtherInput');
            const star = document.getElementById('speciesStatusStar');
            const ownerLabel = document.getElementById('ownerLabel');
            const ownerStar = ownerLabel ? ownerLabel.querySelector('.text-danger') : null;
            const processLabel_cascade = document.getElementById('processLabel');
            const processStar_cascade = processLabel_cascade ? processLabel_cascade.querySelector('.text-danger') : null;
            const photoStars = document.querySelectorAll('.work-photo-title .text-danger');
            function updateRequiredFields(status) {
                if (status === '到場前已自行逃脫') {
                    if (ownerStar) ownerStar.style.display = 'none';
                    if (processStar_cascade) processStar_cascade.style.display = 'none';
                    if (star) star.style.display = 'none';
                    photoStars.forEach(function (s) { s.style.display = 'none'; });
                } else {
                    if (ownerStar) ownerStar.style.display = '';
                    if (processStar_cascade) processStar_cascade.style.display = '';
                    if (star) star.style.display = '';
                    photoStars.forEach(function (s) { s.style.display = ''; });
                }
            }
            if (statusSelect_cascade) {
                statusSelect_cascade.addEventListener('change', function () {
                    if (this.value === '受困') {
                        subBlock.style.display = '';
                    } else {
                        subBlock.style.display = 'none';
                        otherInput.style.display = 'none';
                        if (subSelect) subSelect.value = '';
                    }
                    updateRequiredFields(this.value);
                    updateProcessOptions();
                });
            }
            if (subSelect) {
                subSelect.addEventListener('change', function () {
                    if (this.value === '其他') {
                        otherInput.style.display = '';
                    } else {
                        otherInput.style.display = 'none';
                    }
                });
            }

            // 照片查看功能（僅供查看，不可上傳或刪除）
            function setupPhotoUpload(blockId, inputId, previewId) {
                let modal = document.getElementById('photoModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'photoModal';
                    modal.style.position = 'fixed';
                    modal.style.top = '0';
                    modal.style.left = '0';
                    modal.style.width = '100vw';
                    modal.style.height = '100vh';
                    modal.style.background = 'rgba(0,0,0,0.7)';
                    modal.style.display = 'none';
                    modal.style.justifyContent = 'center';
                    modal.style.alignItems = 'center';
                    modal.style.zIndex = '9999';
                    modal.innerHTML = `
                        <div id='photoModalTitle' style='position:absolute;top:32px;left:32px;color:#fff;font-size:1.25rem;font-weight:bold;text-shadow:0 2px 8px #000a;'></div>
                        <button id='photoModalCloseBtn' style='position:absolute;top:32px;right:32px;background:#fff;border:none;border-radius:50%;width:40px;height:40px;box-shadow:0 2px 8px #0004;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1.5rem;'>×</button>
                        <button id='photoModalPrevBtn' style='position:absolute;left:16px;top:50%;transform:translateY(-50%);background:#fff;border:none;border-radius:50%;width:40px;height:40px;box-shadow:0 2px 8px #0004;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:2rem;'>&lt;</button>
                        <button id='photoModalNextBtn' style='position:absolute;right:16px;top:50%;transform:translateY(-50%);background:#fff;border:none;border-radius:50%;width:40px;height:40px;box-shadow:0 2px 8px #0004;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:2rem;'>&gt;</button>
                        <img id="photoModalImg" style="max-width:90vw;max-height:90vh;border-radius:12px;box-shadow:0 2px 16px #0008;" />
                    `;
                    document.body.appendChild(modal);
                    modal.addEventListener('click', function (e) {
                        if (e.target === modal) {
                            modal.style.display = 'none';
                        }
                    });
                    document.getElementById('photoModalCloseBtn').onclick = function (e) {
                        modal.style.display = 'none';
                        e.stopPropagation();
                    };
                }

                const previewBox = document.getElementById(previewId);
                if (!previewBox) return;

                // 初始化多照片存儲
                if (!window.workPhotoDataMulti) {
                    window.workPhotoDataMulti = [[], [], []]; // 每個階段最多4張照片
                    window.workPhotoTitles = ["處理前紀錄", "處理中紀錄", "處理完成紀錄"];
                }

                // 在審核頁面，添加示例照片數據
                if (blockId === 'workPhotoBlock1' && window.workPhotoDataMulti[0].length === 0) {
                    // 處理前紀錄添加示例照片
                    window.workPhotoDataMulti[0] = ['img/Review01.jpg', 'img/Review02.jpg'];
                }
                if (blockId === 'workPhotoBlock3' && window.workPhotoDataMulti[2].length === 0) {
                    // 處理完成紀錄添加示例照片
                    window.workPhotoDataMulti[2] = ['img/Review03.jpg'];
                }

                const blockIdx = blockId === 'workPhotoBlock1' ? 0 : blockId === 'workPhotoBlock2' ? 1 : 2;

                // 設置照片點擊查看功能
                const photoSlots = previewBox.querySelectorAll('.photo-slot');
                photoSlots.forEach((slot, index) => {
                    const img = slot.querySelector('img');
                    if (img && img.src) {
                        img.onclick = (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            if (window.showPhotoModal) {
                                setTimeout(() => {
                                    window.showPhotoModal(blockIdx, index);
                                }, 100);
                            }
                        };
                    }
                });

                // 初始化模態視窗功能
                if (!window.photoModalSliderInit) {
                    window.photoModalSliderInit = true;
                    window.currentPhotoBlockIdx = 0;
                    window.currentPhotoIdx = 0;

                    window.showPhotoModal = function (blockIdx, photoIdx = 0) {
                        try {
                            console.log('Opening photo modal:', { blockIdx, photoIdx });

                            // 確保模態框存在
                            const modal = document.getElementById("photoModal");
                            if (!modal) {
                                console.error('Photo modal not found');
                                return;
                            }

                            window.currentPhotoBlockIdx = blockIdx;
                            window.currentPhotoIdx = photoIdx;
                            updatePhotoModal();

                            modal.style.display = "flex";

                        } catch (error) {
                            console.error('Error in showPhotoModal:', error);
                        }
                    };

                    function updatePhotoModal() {
                        try {
                            const img = document.getElementById("photoModalImg");
                            const title = document.getElementById("photoModalTitle");
                            if (!img || !title) {
                                console.error('Modal elements not found:', { img: !!img, title: !!title });
                                return;
                            }

                            const photos = window.workPhotoDataMulti[window.currentPhotoBlockIdx];
                            const titlesArr = window.workPhotoTitles;

                            if (photos && photos.length > 0 && photos[window.currentPhotoIdx]) {
                                const currentFile = photos[window.currentPhotoIdx];
                                title.textContent = `${titlesArr[window.currentPhotoBlockIdx]} (${window.currentPhotoIdx + 1}/${photos.length})`;
                                img.style.display = 'block';
                                img.src = currentFile;
                            } else {
                                img.style.display = 'none';
                                img.src = '';
                                title.textContent = '';
                            }
                        } catch (error) {
                            console.error('Error in updatePhotoModal:', error);
                        }
                    }

                    document.getElementById('photoModalPrevBtn').onclick = function (e) {
                        e.stopPropagation();
                        const photos = window.workPhotoDataMulti[window.currentPhotoBlockIdx];
                        if (photos && photos.length > 0) {
                            window.currentPhotoIdx = (window.currentPhotoIdx - 1 + photos.length) % photos.length;
                            updatePhotoModal();
                        }
                    };

                    document.getElementById('photoModalNextBtn').onclick = function (e) {
                        e.stopPropagation();
                        const photos = window.workPhotoDataMulti[window.currentPhotoBlockIdx];
                        if (photos && photos.length > 0) {
                            window.currentPhotoIdx = (window.currentPhotoIdx + 1) % photos.length;
                            updatePhotoModal();
                        }
                    };
                }
            }
            setupPhotoUpload('workPhotoBlock1', '', 'workPhotoPreview1');
            setupPhotoUpload('workPhotoBlock3', '', 'workPhotoPreview3');

            // 定位功能
            const locationBtn = document.getElementById('getLocationBtn');
            const locationField = document.getElementById('locationField');
            if (locationBtn && locationField) {
                locationBtn.addEventListener('click', function () {
                    console.log('定位按鈕已點擊');
                    const arriveTimeField = document.getElementById('arriveTimeField');
                    const now = new Date();
                    const yyyy = now.getFullYear();
                    const mm = String(now.getMonth() + 1).padStart(2, '0');
                    const dd = String(now.getDate()).padStart(2, '0');
                    const hh = String(now.getHours()).padStart(2, '0');
                    const min = String(now.getMinutes()).padStart(2, '0');
                    const ss = String(now.getSeconds()).padStart(2, '0');
                    const dateTimeStr = `${yyyy}/${mm}/${dd} ${hh}:${min}:${ss}`;
                    if (arriveTimeField) arriveTimeField.value = dateTimeStr;
                    locationField.focus();
                    if (!navigator.geolocation) {
                        locationField.value = '瀏覽器不支援定位';
                        return;
                    }
                    locationField.value = '定位中...';
                    navigator.geolocation.getCurrentPosition(
                        function (pos) {
                            locationField.value = pos.coords.latitude + ',' + pos.coords.longitude;
                            console.log('定位成功', pos.coords);
                        },
                        function (err) {
                            let msg = '無法取得定位';
                            if (err && err.message) msg += `: ${err.message}`;
                            locationField.value = msg;
                            console.log('定位失敗', err);
                        },
                        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                    );
                });
            }

            // 收合/展開功能
            const toggleBtn = document.getElementById('toggleBasicInfoBtn');
            const basicBlock = document.getElementById('basicInfoBlock');
            const toggleText = document.getElementById('toggleBasicInfoText');
            const toggleIcon = document.getElementById('toggleBasicInfoIcon');
            let isBasicInfoOpen = true;
            if (toggleBtn && basicBlock) {
                toggleBtn.addEventListener('click', function () {
                    isBasicInfoOpen = !isBasicInfoOpen;
                    if (isBasicInfoOpen) {
                        basicBlock.style.display = '';
                        toggleText.textContent = '收合';
                        toggleIcon.classList.remove('fa-chevron-down');
                        toggleIcon.classList.add('fa-chevron-up');
                    } else {
                        basicBlock.style.display = 'none';
                        toggleText.textContent = '展開';
                        toggleIcon.classList.remove('fa-chevron-up');
                        toggleIcon.classList.add('fa-chevron-down');
                    }
                });
            }
            const toggleDutyBtn = document.getElementById('toggleDutyRecordBtn');
            const dutyBlock = document.getElementById('dutyRecordBlock');
            const toggleDutyText = document.getElementById('toggleDutyRecordText');
            const toggleDutyIcon = document.getElementById('toggleDutyRecordIcon');
            let isDutyRecordOpen = true;
            if (toggleDutyBtn && dutyBlock) {
                toggleDutyBtn.addEventListener('click', function () {
                    isDutyRecordOpen = !isDutyRecordOpen;
                    if (isDutyRecordOpen) {
                        dutyBlock.style.display = '';
                        toggleDutyText.textContent = '收合';
                        toggleDutyIcon.classList.remove('fa-chevron-down');
                        toggleDutyIcon.classList.add('fa-chevron-up');
                    } else {
                        dutyBlock.style.display = 'none';
                        toggleDutyText.textContent = '展開';
                        toggleDutyIcon.classList.remove('fa-chevron-up');
                        toggleDutyIcon.classList.add('fa-chevron-down');
                    }
                });
            }

            // 手機選單收合
            const btn = document.getElementById('mobileMenuBtn');
            const menu = document.getElementById('mobileMenu');
            if (btn && menu) {
                btn.addEventListener('click', () => {
                    menu.classList.toggle('hidden');
                });
            }

            // 電子簽章功能
            const openBtn = document.getElementById('openSignatureModalBtn');
            const signatureModal = document.getElementById('signatureModal');
            const closeBtn = document.getElementById('closeSignatureModalBtn');
            const previewDiv = document.getElementById('signaturePreview');
            let signatureDataURL = '';
            if (openBtn && signatureModal) {
                openBtn.onclick = function () {
                    signatureModal.classList.remove('hidden');
                };
            }
            if (closeBtn && signatureModal) {
                closeBtn.onclick = function () {
                    signatureModal.classList.add('hidden');
                };
            }
            const canvas = document.getElementById('signatureCanvas');
            const ctx = canvas ? canvas.getContext('2d') : null;
            let drawing = false;
            let lastX = 0, lastY = 0;
            if (canvas && ctx) {
                canvas.addEventListener('mousedown', function (e) {
                    drawing = true;
                    const rect = canvas.getBoundingClientRect();
                    lastX = e.clientX - rect.left;
                    lastY = e.clientY - rect.top;
                });
                canvas.addEventListener('mousemove', function (e) {
                    if (!drawing) return;
                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    ctx.beginPath();
                    ctx.moveTo(lastX, lastY);
                    ctx.lineTo(x, y);
                    ctx.strokeStyle = '#222';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    lastX = x;
                    lastY = y;
                });
                canvas.addEventListener('mouseup', function () { drawing = false; });
                canvas.addEventListener('mouseleave', function () { drawing = false; });
                canvas.addEventListener('touchstart', function (e) {
                    drawing = true;
                    const rect = canvas.getBoundingClientRect();
                    const touch = e.touches[0];
                    lastX = touch.clientX - rect.left;
                    lastY = touch.clientY - rect.top;
                });
                canvas.addEventListener('touchmove', function (e) {
                    if (!drawing) return;
                    const rect = canvas.getBoundingClientRect();
                    const touch = e.touches[0];
                    const x = touch.clientX - rect.left;
                    const y = touch.clientY - rect.top;
                    ctx.beginPath();
                    ctx.moveTo(lastX, lastY);
                    ctx.lineTo(x, y);
                    ctx.strokeStyle = '#222';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    lastX = x;
                    lastY = y;
                    e.preventDefault();
                }, { passive: false });
                canvas.addEventListener('touchend', function () { drawing = false; });
                canvas.addEventListener('touchcancel', function () { drawing = false; });
                document.getElementById('clearSignatureBtn').onclick = function () {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                };
                document.getElementById('saveSignatureBtn').onclick = function () {
                    signatureDataURL = canvas.toDataURL('image/png');
                    previewDiv.innerHTML = `<img src='${signatureDataURL}' alt='簽名預覽' style='max-width:160px;max-height:60px;border:1px solid #ADB5BD;border-radius:8px;background:#fff;' />`;
                    signatureModal.classList.add('hidden');
                };
            }
        });
        // 單張照片放大預覽（處理前紀錄）
        window.showPhotoModal = function (idx) {
            // idx: 0 = 處理前紀錄, 2 = 處理完成紀錄
            let modalId = idx === 0 ? 'photoModalSingle' : 'photoModalSingle2';
            let modal = document.getElementById(modalId);
            // 優先顯示 window.workPhotoData[idx]（原始檔案），若無則顯示預設圖
            let imgSrc = (window.workPhotoData && window.workPhotoData[idx]) ? window.workPhotoData[idx] : (idx === 0 ? 'img/Review01.jpg' : 'img/Review03.jpg');
            let altText = idx === 0 ? '處理前紀錄-Review01' : '處理完成紀錄-Review03';
            if (!modal) {
                modal = document.createElement('div');
                modal.id = modalId;
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100vw';
                modal.style.height = '100vh';
                modal.style.background = 'rgba(0,0,0,0.7)';
                modal.style.display = 'flex';
                modal.style.justifyContent = 'center';
                modal.style.alignItems = 'center';
                modal.style.zIndex = '99999';
                modal.innerHTML = `
            <img id="photoModalImgSingle${idx}" src="${imgSrc}" alt="${altText}" style="max-width:90vw;max-height:90vh;object-fit:cover;border-radius:12px;box-shadow:0 2px 16px #0008;display:block;margin:auto;" />
            <button id="photoModalCloseBtnSingle${idx}" style="position:absolute;top:32px;right:32px;background:#fff;border:none;border-radius:50%;width:40px;height:40px;box-shadow:0 2px 8px #0004;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1.5rem;">×</button>
        `;
                document.body.appendChild(modal);
                document.getElementById(`photoModalCloseBtnSingle${idx}`).onclick = function (e) {
                    modal.style.display = 'none';
                    e.stopPropagation();
                };
                modal.onclick = function (e) {
                    if (e.target === modal) modal.style.display = 'none';
                };
            } else {
                var imgEl = document.getElementById(`photoModalImgSingle${idx}`);
                if (imgEl) imgEl.src = imgSrc;
                modal.style.display = 'flex';
            }
        };
    </script>
</body>

</html>